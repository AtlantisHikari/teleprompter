<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æè©æ©Ÿ - ä¸»é¡¯ç¤ºå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            background: #000;
            color: #fff;
            position: relative;
        }
        
        /* æè©æ©Ÿå®¹å™¨ */
        .teleprompter-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .teleprompter-content {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 1.6;
            padding: 2rem;
            transform: translateY(100vh);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 10å€‹å­—é«”å¤§å°ç­‰ç´š */
        .font-size-1 { font-size: 3vh; }
        .font-size-2 { font-size: 4vh; }
        .font-size-3 { font-size: 5vh; }
        .font-size-4 { font-size: 6.5vh; }
        .font-size-5 { font-size: 8vh; }
        .font-size-6 { font-size: 10vh; }
        .font-size-7 { font-size: 13vh; }
        .font-size-8 { font-size: 16vh; }
        .font-size-9 { font-size: 20vh; }
        .font-size-10 { font-size: 25vh; }
        
        /* é¡åƒæ•ˆæœ */
        .mirror-horizontal { transform: scaleX(-1); }
        .mirror-vertical { transform: scaleY(-1); }
        .mirror-both { transform: scale(-1, -1); }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        .status-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .room-id-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            z-index: 1000;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* å¿«æ·éµæç¤º */
        .help-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 2000;
        }
        
        .help-overlay.show {
            display: block;
        }
        
        /* è¡Œé«˜äº®æ¨£å¼ */
        .current-line-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0.2em;
            border-radius: 0.3em;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .teleprompter-content {
                padding: 1rem;
            }
            
            .status-bar, .room-id-display, .connection-status {
                font-size: 10px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div>ğŸ“º ä¸»é¡¯ç¤ºå™¨</div>
        <div>é€Ÿåº¦: <span id="statusSpeed">1.0</span>x | å­—é«”: <span id="statusFont">5</span> | é¡åƒ: <span id="statusMirror">æ­£å¸¸</span></div>
    </div>
    
    <!-- æˆ¿é–“IDé¡¯ç¤º -->
    <div class="room-id-display">
        ğŸ  æˆ¿é–“: <span id="currentRoomId">æœªé€£æ¥</span>
    </div>
    
    <!-- é€£æ¥ç‹€æ…‹ -->
    <div class="connection-status">
        <div id="connectionStatus">ğŸ”´ é›¢ç·š</div>
        <div>è¨­å‚™: <span id="deviceCount">0</span></div>
    </div>
    
    <!-- ä¸»é¡¯ç¤ºå®¹å™¨ -->
    <div class="teleprompter-container">
        <div class="teleprompter-content font-size-5" id="content">
            æ­¡è¿ä½¿ç”¨æ™ºæ…§æè©æ©Ÿ<br>
            è«‹é–‹å•Ÿæ§åˆ¶é¢æ¿è¨­å®šæ–‡ç¨¿å…§å®¹<br><br>
            
            å¿«æ·éµï¼š<br>
            â€¢ ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ<br>
            â€¢ ESCï¼šé¡¯ç¤ºè¨­å®š<br>
            â€¢ â†‘â†“ï¼šèª¿æ•´é€Ÿåº¦<br>
            â€¢ â†â†’ï¼šèª¿æ•´å­—é«”<br>
        </div>
    </div>
    
    <!-- å¿«æ·éµèªªæ˜ -->
    <div class="help-overlay" id="helpOverlay">
        <h3>âŒ¨ï¸ å¿«æ·éµèªªæ˜</h3>
        <div style="margin: 20px 0; text-align: left;">
            <div>ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ</div>
            <div>ESCï¼šé¡¯ç¤º/éš±è—æ­¤èªªæ˜</div>
            <div>â†‘â†“ï¼šèª¿æ•´æ»¾å‹•é€Ÿåº¦</div>
            <div>â†â†’ï¼šèª¿æ•´å­—é«”å¤§å°</div>
            <div>Sï¼šåœæ­¢æ»¾å‹•</div>
            <div>Fï¼šå…¨è¢å¹•æ¨¡å¼</div>
        </div>
        <div style="margin-top: 20px;">
            <button onclick="hideHelp()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                é—œé–‰
            </button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let peer = null;
        let connections = new Map();
        let isHost = false;
        let roomId = '';
        let isConnected = false;
        
        // æè©æ©Ÿè¨­å®š
        let isPlaying = false;
        let scrollSpeed = 1.0;
        let fontSize = 5;
        let textColor = '#ffffff';
        let backgroundColor = '#000000';
        let mirrorMode = 'none';
        let scrollAnimation = null;
        
        // æ‰‹å‹•è¡Œæ§åˆ¶
        let scriptLines = [];
        let currentLineIndex = 0;
        let lineMode = false;
        
        // DOM å…ƒç´ 
        const content = document.getElementById('content');
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initializePeer();
            setupKeyboardShortcuts();
            loadSettings();
            generateRoomId();
        });
        
        // åˆå§‹åŒ– PeerJS
        function initializePeer() {
            try {
                // å˜—è©¦å¤šå€‹ PeerJS æœå‹™å™¨é…ç½®
                const peerConfigs = [
                    {
                        // ä½¿ç”¨é»˜èª PeerJS æœå‹™å™¨
                        secure: window.location.protocol === 'https:',
                        config: {
                            'iceServers': [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' },
                                { urls: 'stun:stun1.l.google.com:19302' },
                                { urls: 'stun:stun2.l.google.com:19302' }
                            ]
                        }
                    }
                ];
                
                peer = new Peer(peerConfigs[0]);

                peer.on('open', function(id) {
                    console.log('Peer ID:', id);
                    isConnected = true;
                    updateConnectionStatus();
                });

                peer.on('connection', function(conn) {
                    handleNewConnection(conn);
                });

                peer.on('error', function(err) {
                    console.error('PeerJSéŒ¯èª¤:', err);
                    updateConnectionStatus();
                    
                    if (err.type === 'network' || err.type === 'server-error') {
                        setTimeout(() => {
                            console.log('å˜—è©¦é‡æ–°é€£æ¥...');
                            initializePeer();
                        }, 3000);
                    }
                });
            } catch (error) {
                console.error('PeerJSåˆå§‹åŒ–å¤±æ•—:', error);
                updateConnectionStatus();
            }
        }
        
        // è™•ç†æ–°é€£æ¥
        function handleNewConnection(conn) {
            conn.on('open', function() {
                connections.set(conn.peer, conn);
                updateDeviceCount();
                console.log('æ–°è¨­å‚™å·²é€£æ¥:', conn.peer);
                
                // ç™¼é€ç•¶å‰è¨­å®šçµ¦æ–°é€£æ¥çš„è¨­å‚™
                sendToConnection(conn, 'settings-sync', {
                    textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode,
                    script: content.textContent,
                    totalLines: scriptLines.length,
                    currentLine: currentLineIndex + 1
                });
            });

            conn.on('data', function(message) {
                handleMessage(message, conn);
            });

            conn.on('close', function() {
                connections.delete(conn.peer);
                updateDeviceCount();
                console.log('è¨­å‚™å·²æ–·é–‹:', conn.peer);
            });
        }
        
        // è™•ç†è¨Šæ¯
        function handleMessage(message, conn) {
            console.log('æ”¶åˆ°è¨Šæ¯:', message);
            
            switch (message.type) {
                case 'play-pause':
                    if (message.data.isPlaying) {
                        playScript();
                    } else {
                        pauseScript();
                    }
                    break;
                case 'stop':
                    stopScript();
                    break;
                case 'speed-change':
                    changeSpeed(message.data.speed);
                    break;
                case 'font-change':
                    changeFontSize(message.data.fontSize);
                    break;
                case 'color-change':
                    if (message.data.textColor) setTextColor(message.data.textColor);
                    if (message.data.backgroundColor) setBackgroundColor(message.data.backgroundColor);
                    break;
                case 'mirror-change':
                    setMirror(message.data.mirrorMode);
                    break;
                case 'script-update':
                    updateScript(message.data.script);
                    break;
                case 'jump-to-line':
                    jumpToLine(message.data.line);
                    break;
                case 'previous-line':
                    previousLine();
                    break;
                case 'next-line':
                    nextLine();
                    break;
                case 'request-settings':
                    sendCurrentSettings(conn);
                    break;
            }
        }
        
        // å»£æ’­è¨Šæ¯çµ¦æ‰€æœ‰é€£æ¥
        function broadcastMessage(type, data) {
            connections.forEach(conn => {
                if (conn.open) {
                    sendToConnection(conn, type, data);
                }
            });
        }
        
        // ç™¼é€è¨Šæ¯çµ¦ç‰¹å®šé€£æ¥
        function sendToConnection(conn, type, data) {
            try {
                conn.send({ type: type, data: data });
            } catch (error) {
                console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', error);
            }
        }
        
        // ç™¼é€ç•¶å‰è¨­å®š
        function sendCurrentSettings(conn) {
            sendToConnection(conn, 'settings-response', {
                textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode,
                script: content.textContent,
                totalLines: scriptLines.length,
                currentLine: currentLineIndex + 1,
                isPlaying: isPlaying
            });
        }
        
        // æ’­æ”¾æ§åˆ¶
        function playScript() {
            if (isPlaying) return;
            
            isPlaying = true;
            updateConnectionStatus();
            
            if (lineMode) {
                // è¡Œæ¨¡å¼ä¸‹ä¸è‡ªå‹•æ»¾å‹•
                return;
            }
            
            // é€£çºŒæ»¾å‹•æ¨¡å¼
            const scrollDistance = 1; // æ¯æ¬¡ç§»å‹•çš„åƒç´ 
            const intervalTime = 50 / scrollSpeed; // æ ¹æ“šé€Ÿåº¦èª¿æ•´é–“éš”
            
            scrollAnimation = setInterval(() => {
                const currentTransform = content.style.transform || 'translateY(100vh)';
                const currentY = parseFloat(currentTransform.match(/translateY\\(([^)]+)\\)/)?.[1] || '100vh');
                const newY = currentY - scrollDistance;
                
                content.style.transform = `translateY(${newY}px)`;
                
                // å¦‚æœæ»¾å‹•å®Œç•¢ï¼Œåœæ­¢
                if (newY < -content.offsetHeight) {
                    stopScript();
                }
            }, intervalTime);
        }
        
        function pauseScript() {
            isPlaying = false;
            updateConnectionStatus();
            
            if (scrollAnimation) {
                clearInterval(scrollAnimation);
                scrollAnimation = null;
            }
        }
        
        function stopScript() {
            pauseScript();
            content.style.transform = 'translateY(100vh)';
            currentLineIndex = 0;
            
            if (lineMode) {
                displayCurrentLine();
            }
        }
        
        // è¨­å®šæ§åˆ¶
        function changeSpeed(value) {
            scrollSpeed = parseFloat(value);
            document.getElementById('statusSpeed').textContent = scrollSpeed.toFixed(1);
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°é–‹å§‹ä»¥æ‡‰ç”¨æ–°é€Ÿåº¦
            if (isPlaying) {
                pauseScript();
                playScript();
            }
        }
        
        function changeFontSize(value) {
            fontSize = parseInt(value);
            content.className = content.className.replace(/font-size-\\d+/, `font-size-${fontSize}`);
            document.getElementById('statusFont').textContent = fontSize;
        }
        
        function setTextColor(color) {
            textColor = color;
            content.style.color = color;
        }
        
        function setBackgroundColor(color) {
            backgroundColor = color;
            document.body.style.backgroundColor = color;
        }
        
        function setMirror(mode) {
            mirrorMode = mode;
            content.className = content.className.replace(/mirror-\\w+/g, '');
            
            if (mode !== 'none') {
                content.classList.add(`mirror-${mode}`);
            }
            
            const mirrorNames = {
                'none': 'æ­£å¸¸',
                'horizontal': 'æ°´å¹³é¡åƒ',
                'vertical': 'å‚ç›´é¡åƒ',
                'both': 'é›™å‘é¡åƒ'
            };
            document.getElementById('statusMirror').textContent = mirrorNames[mode];
        }
        
        function updateScript(scriptText) {
            content.textContent = scriptText;
            updateScriptLines();
        }
        
        // æ‰‹å‹•è¡Œæ§åˆ¶
        function updateScriptLines() {
            const scriptText = content.textContent || '';
            scriptLines = scriptText.split('\\n').filter(line => line.trim() !== '');
            
            // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™
            broadcastMessage('total-lines', { totalLines: scriptLines.length });
            
            console.log('æ–‡ç¨¿æ›´æ–°ï¼Œç¸½å…±', scriptLines.length, 'è¡Œ');
        }
        
        function jumpToLine(lineNumber) {
            if (lineNumber < 1 || lineNumber > scriptLines.length) {
                console.log('è¡Œè™Ÿè¶…å‡ºç¯„åœ:', lineNumber);
                return;
            }
            
            currentLineIndex = lineNumber - 1;
            lineMode = true;
            displayCurrentLine();
            
            // é€šçŸ¥æ§åˆ¶è¨­å‚™
            broadcastMessage('current-line-update', { 
                currentLine: currentLineIndex + 1,
                totalLines: scriptLines.length 
            });
        }
        
        function previousLine() {
            if (currentLineIndex > 0) {
                currentLineIndex--;
                lineMode = true;
                displayCurrentLine();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        function nextLine() {
            if (currentLineIndex < scriptLines.length - 1) {
                currentLineIndex++;
                lineMode = true;
                displayCurrentLine();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        function displayCurrentLine() {
            if (scriptLines.length === 0) return;
            
            // é¡¯ç¤ºç•¶å‰è¡ŒåŠå‰å¾Œæ–‡
            const contextLines = 3;
            const startIndex = Math.max(0, currentLineIndex - contextLines);
            const endIndex = Math.min(scriptLines.length, currentLineIndex + contextLines + 1);
            
            let displayText = '';
            for (let i = startIndex; i < endIndex; i++) {
                const line = scriptLines[i];
                if (i === currentLineIndex) {
                    displayText += `<span class="current-line-highlight">${line}</span>\\n`;
                } else {
                    const opacity = Math.abs(i - currentLineIndex) <= 1 ? 1 : 0.6;
                    displayText += `<span style="opacity: ${opacity};">${line}</span>\\n`;
                }
            }
            
            content.innerHTML = displayText;
            
            // é‡ç½®æ»¾å‹•ä½ç½®ä»¥ç¢ºä¿ç•¶å‰è¡Œå¯è¦‹
            content.style.transform = 'translateY(20vh)';
        }
        
        // éµç›¤å¿«æ·éµ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (isPlaying) {
                            pauseScript();
                        } else {
                            playScript();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        toggleHelp();
                        break;
                    case 'KeyS':
                        e.preventDefault();
                        stopScript();
                        break;
                    case 'KeyF':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        changeSpeed(Math.min(5.0, scrollSpeed + 0.1));
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        changeSpeed(Math.max(0.1, scrollSpeed - 0.1));
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        changeFontSize(Math.max(1, fontSize - 1));
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        changeFontSize(Math.min(10, fontSize + 1));
                        break;
                }
            });
        }
        
        // å·¥å…·å‡½æ•¸
        function generateRoomId() {
            roomId = 'room-' + Math.random().toString(36).substr(2, 9);
            document.getElementById('currentRoomId').textContent = roomId;
            
            if (peer && peer.open) {
                isHost = true;
                console.log('æˆ¿é–“å·²å‰µå»º:', roomId);
            }
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            
            if (isConnected) {
                statusElement.innerHTML = 'ğŸŸ¢ åœ¨ç·š';
            } else {
                statusElement.innerHTML = 'ğŸ”´ é›¢ç·š';
            }
        }
        
        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = connections.size;
        }
        
        function toggleHelp() {
            const helpOverlay = document.getElementById('helpOverlay');
            helpOverlay.classList.toggle('show');
        }
        
        function hideHelp() {
            document.getElementById('helpOverlay').classList.remove('show');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function loadSettings() {
            // å¾ localStorage è¼‰å…¥è¨­å®š
            const savedSettings = localStorage.getItem('teleprompter-settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.textColor) setTextColor(settings.textColor);
                if (settings.backgroundColor) setBackgroundColor(settings.backgroundColor);
                if (settings.fontSize) changeFontSize(settings.fontSize);
                if (settings.scrollSpeed) changeSpeed(settings.scrollSpeed);
                if (settings.mirrorMode) setMirror(settings.mirrorMode);
            }
        }
        
        function saveSettings() {
            const settings = {
                textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode
            };
            localStorage.setItem('teleprompter-settings', JSON.stringify(settings));
        }
        
        // é é¢é—œé–‰å‰ä¿å­˜è¨­å®š
        window.addEventListener('beforeunload', saveSettings);
        
        // åˆå§‹åŒ–è¡Œæ•¸çµ±è¨ˆ
        window.addEventListener('load', function() {
            setTimeout(updateScriptLines, 500);
        });
    </script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</body>
</html>
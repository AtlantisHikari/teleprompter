<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æè©æ©Ÿ - ä¸»é¡¯ç¤ºå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            background: #000;
            color: #fff;
            position: relative;
        }
        
        /* æè©æ©Ÿå®¹å™¨ */
        .teleprompter-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* è¡Œè™Ÿé¡¯ç¤º */
        .line-numbers {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1vh;
            font-size: 2vh;
            color: rgba(255, 255, 255, 0.3);
            font-family: monospace;
            z-index: 10;
            line-height: 1.6;
        }
        
        .line-number {
            padding: 0.2em 0.5em;
            border-radius: 0.3em;
            background: rgba(255, 255, 255, 0.05);
            min-width: 3em;
            text-align: center;
            transition: all 0.3s;
        }
        
        .line-number.current {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .teleprompter-content {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 1.6;
            padding: 2rem;
            transform: translateY(100vh);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 10å€‹å­—é«”å¤§å°ç­‰ç´š */
        .font-size-1 { font-size: 3vh; }
        .font-size-2 { font-size: 4vh; }
        .font-size-3 { font-size: 5vh; }
        .font-size-4 { font-size: 6.5vh; }
        .font-size-5 { font-size: 8vh; }
        .font-size-6 { font-size: 10vh; }
        .font-size-7 { font-size: 13vh; }
        .font-size-8 { font-size: 16vh; }
        .font-size-9 { font-size: 20vh; }
        .font-size-10 { font-size: 25vh; }
        
        /* é¡åƒæ•ˆæœ - åªé€šéJavaScriptå…§è¯æ¨£å¼æ‡‰ç”¨ï¼Œé¿å…CSSè¡çª */
        .mirror-horizontal { transform: scaleX(-1) !important; }
        .mirror-vertical { transform: scaleY(-1) !important; }
        .mirror-both { transform: scale(-1, -1) !important; }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        .status-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .room-id-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            z-index: 1000;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* å¿«æ·éµæç¤º */
        .help-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 2000;
        }
        
        .help-overlay.show {
            display: block;
        }
        
        /* è¡Œé«˜äº®æ¨£å¼ */
        .current-line-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0.2em;
            border-radius: 0.3em;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .teleprompter-content {
                padding: 1rem;
            }
            
            .status-bar, .room-id-display, .connection-status {
                font-size: 10px;
                padding: 8px 12px;
            }
        }
        
        /* è¨­å®šæŒ‰éˆ• */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #666;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .settings-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: #999;
        }
        
        /* è¨­å®šé¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: 100vh;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            border-left: 2px solid #444;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        /* è¨­å®šé¢æ¿å…§å®¹æ¨£å¼ */
        .setting-group {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(50, 50, 50, 0.8);
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        
        .setting-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #222;
            color: white;
            font-size: 14px;
        }
        
        .slider-group {
            margin-bottom: 20px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .slider-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        /* é¡åƒæŒ‰éˆ•æ´»å‹•ç‹€æ…‹ */
        .btn.active {
            background: #28a745 !important;
            color: white !important;
        }
        
        /* æ–‡ç¨¿æ­·å²æ¨£å¼ */
        .script-history {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .script-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .script-item:last-child {
            margin-bottom: 0;
        }
        
        .script-preview {
            font-size: 12px;
            color: #fff;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .script-timestamp {
            font-size: 10px;
            color: #ccc;
            margin-bottom: 8px;
        }
        
        .script-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-small.delete-btn {
            background: rgba(244, 67, 54, 0.6);
        }
        
        .btn-small.delete-btn:hover {
            background: rgba(244, 67, 54, 0.8);
        }
        
        /* é¡è‰²é¸æ“‡å™¨ */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 100%;
            height: 24px;
            border: 2px solid #666;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .color-option:hover {
            transform: scale(1.05);
            border-color: #fff;
        }
        
        .color-option.selected {
            border-color: #2196F3;
            border-width: 3px;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        }
        
        .color-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* é¡åƒæ¨¡å¼ç¾åœ¨ä½¿ç”¨å…§è¯æ¨£å¼è™•ç†ï¼Œä»¥å…¼å®¹æ»¾å‹•å‹•ç•« */
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div>ğŸ“º ä¸»é¡¯ç¤ºå™¨</div>
        <div>é€Ÿåº¦: <span id="statusSpeed">1.0</span>x | å­—é«”: <span id="statusFont">5</span> | é¡åƒ: <span id="statusMirror">æ­£å¸¸</span></div>
    </div>
    
    <!-- æˆ¿é–“IDé¡¯ç¤º -->
    <div class="room-id-display">
        ğŸ  æˆ¿é–“: <span id="currentRoomId">æœªé€£æ¥</span>
    </div>
    
    <!-- é€£æ¥ç‹€æ…‹ -->
    <div class="connection-status">
        <div id="connectionStatus">ğŸ”´ é›¢ç·š</div>
        <div>è¨­å‚™: <span id="deviceCount">0</span></div>
    </div>
    
    <!-- è¨­å®šæŒ‰éˆ• -->
    <button class="settings-toggle" onclick="toggleSettings()">âš™ï¸ è¨­å®š</button>
    
    <!-- è¨­å®šé¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <h2 style="margin-bottom: 20px; color: #fff;">æè©æ©Ÿè¨­å®š</h2>
        
        <!-- æ’­æ”¾æ§åˆ¶ -->
        <div class="setting-group">
            <label class="setting-label">æ’­æ”¾æ§åˆ¶</label>
            <div class="button-group">
                <button class="btn btn-success" onclick="playScript()">â–¶ æ’­æ”¾</button>
                <button class="btn btn-warning" onclick="pauseScript()">â¸ æš«åœ</button>
                <button class="btn btn-danger" onclick="stopScript()">â¹ åœæ­¢</button>
            </div>
        </div>
        
        <!-- æ»¾å‹•è¨­å®š -->
        <div class="setting-group">
            <label class="setting-label">âš¡ æ»¾å‹•è¨­å®š</label>
            <div class="slider-group">
                <div class="slider-label">
                    <span>æ»¾å‹•é€Ÿåº¦</span>
                    <span class="slider-value" id="speedValue">1.0</span>
                </div>
                <input type="range" min="0.1" max="5" step="0.1" value="1" class="setting-input" 
                       id="speedSlider" oninput="changeSpeed(this.value)">
            </div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>å­—é«”å¤§å°</span>
                    <span class="slider-value" id="fontSizeValue">5</span>
                </div>
                <input type="range" min="1" max="10" step="1" value="5" class="setting-input" 
                       id="fontSizeSlider" oninput="changeFontSize(this.value)">
            </div>
        </div>
        
        <!-- æ–‡å­—é¡è‰² -->
        <div class="setting-group">
            <label class="setting-label">æ–‡å­—é¡è‰²</label>
            <div class="color-picker" id="textColorPicker"></div>
        </div>
        
        <!-- èƒŒæ™¯é¡è‰² -->
        <div class="setting-group">
            <label class="setting-label">èƒŒæ™¯é¡è‰²</label>
            <div class="color-picker" id="bgColorPicker"></div>
        </div>
        
        <!-- é¡åƒæ¨¡å¼ -->
        <div class="setting-group">
            <label class="setting-label">é¡åƒæ¨¡å¼</label>
            <div class="button-group">
                <button class="btn btn-primary" id="mirrorBtn-none" onclick="setMirror('none')">æ­£å¸¸</button>
                <button class="btn btn-primary" id="mirrorBtn-horizontal" onclick="setMirror('horizontal')">æ°´å¹³</button>
            </div>
            <div class="button-group" style="margin-top: 5px;">
                <button class="btn btn-primary" id="mirrorBtn-vertical" onclick="setMirror('vertical')">å‚ç›´</button>
                <button class="btn btn-primary" id="mirrorBtn-both" onclick="setMirror('both')">é›™å‘</button>
            </div>
        </div>
        
        <!-- æ‰‹å‹•æ’­æ”¾ -->
        <div class="setting-group">
            <label class="setting-label">ğŸ¯ æ‰‹å‹•æ’­æ”¾</label>
            <div style="margin-bottom: 10px; font-size: 12px; color: #ccc;">
                æ¨¡å¼: <span id="playbackModeDisplay">è‡ªå‹•æ¨¡å¼</span> | 
                ç›®å‰ç¬¬ <span id="currentLineDisplay">0</span> è¡Œï¼Œå…± <span id="totalLinesDisplay">0</span> è¡Œ
            </div>
            
            <!-- è¡Œæ§åˆ¶ -->
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <button class="btn btn-primary" onclick="previousLine()">â¬† ä¸Šä¸€è¡Œ</button>
                <button class="btn btn-primary" onclick="nextLine()">â¬‡ ä¸‹ä¸€è¡Œ</button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <input type="number" id="jumpToLineInput" min="1" value="1" class="setting-input" 
                       style="width: 80px;" placeholder="è¡Œè™Ÿ">
                <button class="btn btn-warning" onclick="jumpToLineFromInput()">è·³è½‰åˆ°è¡Œ</button>
            </div>
            
            <!-- æ‰‹å‹•æ’­æ”¾æ§åˆ¶ -->
            <div class="button-group" style="margin-top: 10px;">
                <button class="btn btn-success" onclick="continueFromCurrentLine()" id="continueBtn" disabled>â–¶ ç¹¼çºŒæè©</button>
                <button class="btn btn-warning" onclick="pauseManualMode()" id="pauseManualBtn" disabled>â¸ æš«åœ</button>
                <button class="btn btn-danger" onclick="returnToAutoMode()" id="returnAutoBtn" disabled>ğŸ”„ å›è‡ªå‹•æ¨¡å¼</button>
            </div>
        </div>
        
        <!-- æ–‡ç¨¿ç®¡ç† -->
        <div class="setting-group">
            <label class="setting-label">æ–‡ç¨¿å…§å®¹</label>
            <textarea id="scriptEditor" rows="8" class="setting-input" 
                      placeholder="åœ¨æ­¤è¼¸å…¥æ–‡ç¨¿å…§å®¹..." maxlength="2000"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="applyScript()">æŠ•å½±åˆ°ä¸»ç•«é¢</button>
            </div>
        </div>
        
        <!-- æ–‡ç¨¿æ­·å² -->
        <div class="setting-group">
            <label class="setting-label">ğŸ“š æ–‡ç¨¿æ­·å²</label>
            <div id="scriptHistory" class="script-history"></div>
            <div class="button-group">
                <button class="btn btn-success" onclick="saveCurrentScript()">ğŸ’¾ ä¿å­˜ç•¶å‰æ–‡ç¨¿</button>
                <button class="btn btn-danger" onclick="clearScriptHistory()">ğŸ—‘ï¸ æ¸…ç©ºæ­·å²</button>
            </div>
        </div>
        
        <!-- é—œé–‰æŒ‰éˆ• -->
        <button class="btn btn-danger" onclick="toggleSettings()" style="width: 100%; margin-top: 20px;">
            é—œé–‰è¨­å®š
        </button>
    </div>
    
    <!-- ä¸»é¡¯ç¤ºå®¹å™¨ -->
    <div class="teleprompter-container">
        <!-- è¡Œè™Ÿé¡¯ç¤º -->
        <div class="line-numbers" id="lineNumbers"></div>
        
        <div class="teleprompter-content font-size-5" id="content">æ­¡è¿ä½¿ç”¨æ™ºæ…§æè©æ©Ÿ<br>è«‹é–‹å•Ÿæ§åˆ¶é¢æ¿è¨­å®šæ–‡ç¨¿å…§å®¹<br><br>å¿«æ·éµï¼š<br>â€¢ ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ<br>â€¢ ESCï¼šé¡¯ç¤ºè¨­å®š<br>â€¢ â†‘â†“ï¼šèª¿æ•´é€Ÿåº¦<br>â€¢ â†â†’ï¼šèª¿æ•´å­—é«”</div>
    </div>
    
    <!-- å¿«æ·éµèªªæ˜ -->
    <div class="help-overlay" id="helpOverlay">
        <h3>âŒ¨ï¸ å¿«æ·éµèªªæ˜</h3>
        <div style="margin: 20px 0; text-align: left;">
            <div>ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ</div>
            <div>ESCï¼šé¡¯ç¤º/éš±è—æ­¤èªªæ˜</div>
            <div>â†‘â†“ï¼šèª¿æ•´æ»¾å‹•é€Ÿåº¦</div>
            <div>â†â†’ï¼šèª¿æ•´å­—é«”å¤§å°</div>
            <div>Sï¼šåœæ­¢æ»¾å‹•</div>
            <div>Fï¼šå…¨è¢å¹•æ¨¡å¼</div>
        </div>
        <div style="margin-top: 20px;">
            <button onclick="hideHelp()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                é—œé–‰
            </button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let peer = null;
        let connections = new Map();
        let isHost = false;
        let roomId = '';
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 1000;
        
        // æè©æ©Ÿè¨­å®š
        let isPlaying = false;
        let scrollSpeed = 1.0;
        let fontSize = 5;
        let textColor = '#ffffff';
        let backgroundColor = '#000000';
        let mirrorMode = 'none';
        let scrollAnimation = null;
        
        // æ‰‹å‹•è¡Œæ§åˆ¶
        let scriptLines = [];
        let currentLineIndex = 0;
        let lineMode = false;
        let manualMode = false; // æ‰‹å‹•æ’­æ”¾æ¨¡å¼é–‹é—œ
        
        // DOM å…ƒç´ ï¼ˆå°‡åœ¨DOMè¼‰å…¥å¾Œåˆå§‹åŒ–ï¼‰
        let content = null;
        
        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–DOMå…ƒç´ 
            content = document.getElementById('content');
            
            // ç¢ºä¿ content å…ƒç´ æ­£ç¢ºåˆå§‹åŒ–
            if (content) {
                // å¼·åˆ¶ç§»é™¤ä»»ä½•å¯èƒ½çš„é¡åƒé¡åˆ¥å’Œé‡ç½®æ‰€æœ‰transform
                content.classList.remove('mirror-horizontal', 'mirror-vertical', 'mirror-both');
                content.style.transform = '';
                // ç¢ºä¿é è¨­ä½ç½®ï¼šæ­£å¸¸æ–¹å‘ï¼Œå¾åº•éƒ¨é–‹å§‹
                content.style.transform = 'translateY(100vh) scaleX(1) scaleY(1)';
                console.log('âœ… Content å…ƒç´ åˆå§‹åŒ–å®Œæˆï¼Œç§»é™¤ä»»ä½•ç¿»è½‰æ•ˆæœ');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ° content å…ƒç´ ');
            }
            
            initializePeer();
            setupKeyboardShortcuts();
            loadSettings();
            
            // åˆå§‹åŒ–æ–‡ç¨¿å…§å®¹
            setTimeout(() => {
                updateScriptLines();
                updateLineNumbers();
                initializeSettings();
            }, 100);
        });
        
        // æª¢æŸ¥ç€è¦½å™¨å…¼å®¹æ€§
        function checkBrowserCompatibility() {
            const issues = [];
            
            // æª¢æŸ¥ WebRTC æ”¯æ´
            if (!window.RTCPeerConnection && !window.webkitRTCPeerConnection && !window.mozRTCPeerConnection) {
                issues.push('WebRTCä¸æ”¯æ´');
            }
            
            // æª¢æŸ¥ WebSocket æ”¯æ´
            if (!window.WebSocket) {
                issues.push('WebSocketä¸æ”¯æ´');
            }
            
            // æª¢æŸ¥ localStorage æ”¯æ´
            if (!window.localStorage) {
                issues.push('localStorageä¸æ”¯æ´');
            }
            
            // æª¢æŸ¥åŸºæœ¬ ES6 åŠŸèƒ½
            try {
                new Map();
                new Set();
            } catch (e) {
                issues.push('ES6åŠŸèƒ½ä¸å®Œæ•´');
            }
            
            return issues;
        }
        
        // åˆå§‹åŒ– PeerJS
        function initializePeer() {
            try {
                // æª¢æŸ¥ç€è¦½å™¨å…¼å®¹æ€§
                const compatibilityIssues = checkBrowserCompatibility();
                if (compatibilityIssues.length > 0) {
                    console.warn('âš ï¸ ç€è¦½å™¨å…¼å®¹æ€§å•é¡Œ:', compatibilityIssues.join(', '));
                    showNotification(`âš ï¸ ç€è¦½å™¨å…¼å®¹æ€§å•é¡Œ: ${compatibilityIssues.join(', ')}ï¼Œå»ºè­°ä½¿ç”¨Chromeæˆ–Firefoxæœ€æ–°ç‰ˆæœ¬`);
                }
                
                // æª¢æŸ¥ PeerJS æ˜¯å¦æˆåŠŸè¼‰å…¥
                if (typeof Peer === 'undefined') {
                    console.error('âŒ PeerJS åº«æœªæˆåŠŸè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                    updateConnectionStatus();
                    showNotification('âŒ ç„¡æ³•è¼‰å…¥PeerJSåº«ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç¶²è·¯é€£æ¥');
                    return;
                }
                
                // ä½¿ç”¨éš¨æ©ŸIDé¿å…è¡çª
                const randomId = 'main-' + Math.random().toString(36).substr(2, 9);
                
                // PeerJS é…ç½® - ä½¿ç”¨å¤šå€‹å¯é çš„é…ç½®é¸é …
                const peerConfig = {
                    // ä½¿ç”¨éš¨æ©Ÿç”Ÿæˆçš„ID
                    key: 'peerjs',
                    debug: 1, // å•Ÿç”¨èª¿è©¦æ¨¡å¼
                    secure: window.location.protocol === 'https:',
                    config: {
                        'iceServers': [
                            // Google STUN æœåŠ¡å™¨ï¼ˆå…¨çƒè¦†ç›–ï¼‰
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' },
                            
                            // Twilio STUN æœåŠ¡å™¨ï¼ˆå¯é æ€§é«˜ï¼‰
                            { urls: 'stun:global.stun.twilio.com:3478' },
                            
                            // Mozilla STUN æœåŠ¡å™¨ï¼ˆFirefox ä¼˜åŒ–ï¼‰
                            { urls: 'stun:stun.mozilla.org:3478' },
                            
                            // OpenRelay STUN æœåŠ¡å™¨ï¼ˆå¼€æºç¨³å®šï¼‰
                            { urls: 'stun:openrelay.metered.ca:80' },
                            
                            // CloudFlare STUN æœåŠ¡å™¨ï¼ˆä½å»¶è¿Ÿï¼‰
                            { urls: 'stun:stun.cloudflare.com:3478' },
                            
                            // å¤‡ç”¨ STUN æœåŠ¡å™¨ï¼ˆç‰¹æ®Šç½‘ç»œç¯å¢ƒï¼‰
                            { urls: 'stun:relay.webrtc.win:3478' },
                            { urls: 'stun:stun.nextcloud.com:443' }
                        ],
                        'iceCandidatePoolSize': 15,
                        'iceTransportPolicy': 'all',
                        'bundlePolicy': 'balanced',
                        'rtcpMuxPolicy': 'require',
                        'sdpSemantics': 'unified-plan'
                    }
                };
                
                console.log('æ­£åœ¨åˆå§‹åŒ–PeerJSï¼ŒID:', randomId);
                peer = new Peer(randomId, peerConfig);

                peer.on('open', function(id) {
                    console.log('âœ… PeerJSé€£ç·šæˆåŠŸï¼ŒPeer ID:', id);
                    isConnected = true;
                    roomId = id; // ä½¿ç”¨Peer IDä½œç‚ºæˆ¿é–“ID
                    reconnectAttempts = 0; // æˆåŠŸé€£æ¥å¾Œé‡ç½®é‡é€£è¨ˆæ•¸å™¨
                    updateConnectionStatus();
                    
                    // æ›´æ–°æˆ¿é–“IDé¡¯ç¤º
                    const roomDisplay = document.getElementById('currentRoomId');
                    if (roomDisplay) {
                        roomDisplay.textContent = id;
                    }
                    
                    showNotification('âœ… ä¸»é¡¯ç¤ºå™¨å·²ä¸Šç·šï¼Œæˆ¿é–“ID: ' + id);
                });

                peer.on('connection', function(conn) {
                    console.log('ğŸ“± æ”¶åˆ°æ–°çš„é€£ç·š:', conn.peer);
                    handleNewConnection(conn);
                });

                peer.on('error', function(err) {
                    console.error('âŒ PeerJSéŒ¯èª¤:', err.type, err.message);
                    isConnected = false;
                    updateConnectionStatus();
                    
                    // æ™ºèƒ½é‡é€£æ©Ÿåˆ¶
                    if (reconnectAttempts < maxReconnectAttempts) {
                        const delay = reconnectDelay * Math.pow(2, reconnectAttempts); // æŒ‡æ•¸é€€é¿
                        reconnectAttempts++;
                        
                        switch(err.type) {
                            case 'network':
                                console.log(`ğŸ”„ ç¶²è·¯éŒ¯èª¤ï¼Œ${delay}mså¾Œé‡æ–°é€£æ¥... (å˜—è©¦ ${reconnectAttempts}/${maxReconnectAttempts})`);
                                showNotification(`ğŸ”„ ç¶²è·¯é€£æ¥ä¸­æ–·ï¼Œæ­£åœ¨é‡é€£... (${reconnectAttempts}/${maxReconnectAttempts})`);
                                setTimeout(() => {
                                    if (peer) peer.destroy();
                                    initializePeer();
                                }, delay);
                                break;
                            case 'server-error':
                                console.log(`ğŸ”„ æœå‹™å™¨éŒ¯èª¤ï¼Œ${delay}mså¾Œé‡æ–°é€£æ¥... (å˜—è©¦ ${reconnectAttempts}/${maxReconnectAttempts})`);
                                showNotification(`ğŸ”„ æœå‹™å™¨é€£æ¥å¤±æ•—ï¼Œæ­£åœ¨é‡é€£... (${reconnectAttempts}/${maxReconnectAttempts})`);
                                setTimeout(() => {
                                    if (peer) peer.destroy();
                                    initializePeer();
                                }, delay);
                                break;
                            case 'unavailable-id':
                                console.log('ğŸ”„ IDå·²è¢«ä½¿ç”¨ï¼Œç«‹å³é‡æ–°ç”Ÿæˆ...');
                                showNotification('ğŸ”„ IDè¡çªï¼Œæ­£åœ¨é‡æ–°ç”Ÿæˆ...');
                                setTimeout(() => {
                                    if (peer) peer.destroy();
                                    initializePeer();
                                }, 500);
                                break;
                            case 'peer-unavailable':
                                console.log('âš ï¸ å°æ–¹ä¸åœ¨ç·šæˆ–IDä¸å­˜åœ¨');
                                showNotification('âš ï¸ ç›®æ¨™è¨­å‚™ä¸åœ¨ç·šæˆ–IDä¸å­˜åœ¨');
                                break;
                            default:
                                console.log('âš ï¸ å…¶ä»–éŒ¯èª¤:', err.type);
                                showNotification(`âš ï¸ é€£æ¥éŒ¯èª¤: ${err.type}`);
                        }
                    } else {
                        console.error('âŒ é‡é€£æ¬¡æ•¸å·²é”ä¸Šé™ï¼Œåœæ­¢å˜—è©¦');
                        showNotification('âŒ å¤šæ¬¡é‡é€£å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç¶²è·¯');
                        reconnectAttempts = 0; // é‡ç½®è¨ˆæ•¸å™¨
                    }
                });

                peer.on('disconnected', function() {
                    console.log('ğŸ”Œ PeerJSé€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...');
                    isConnected = false;
                    updateConnectionStatus();
                    
                    // å˜—è©¦é‡æ–°é€£æ¥åˆ°PeerJSæœå‹™å™¨
                    if (!peer.destroyed) {
                        peer.reconnect();
                    }
                });
            } catch (error) {
                console.error('PeerJSåˆå§‹åŒ–å¤±æ•—:', error);
                updateConnectionStatus();
            }
        }
        
        // è™•ç†æ–°é€£æ¥
        // é‡è¤‡çš„å‡½æ•¸å·²ç§»é™¤ï¼Œä½¿ç”¨ä¸‹é¢æ›´å®Œæ•´çš„ç‰ˆæœ¬
        
        // è™•ç†æ–°é€£ç·š
        function handleNewConnection(conn) {
            // å°‡é€£ç·šåŠ å…¥connections Map
            connections.set(conn.peer, conn);
            updateDeviceCount();
            
            conn.on('open', function() {
                console.log('âœ… æ§åˆ¶è¨­å‚™å·²é€£æ¥:', conn.peer);
                showNotification(`ğŸ“± æ§åˆ¶è¨­å‚™å·²é€£æ¥: ${conn.peer}`);
                
                // ç™¼é€ç•¶å‰è¨­å®šçµ¦æ–°é€£æ¥çš„è¨­å‚™
                sendCurrentSettings(conn);
            });
            
            conn.on('data', function(message) {
                handleMessage(message, conn);
            });
            
            conn.on('close', function() {
                connections.delete(conn.peer);
                updateDeviceCount();
                console.log('ğŸ“± æ§åˆ¶è¨­å‚™å·²æ–·é–‹:', conn.peer);
                showNotification(`ğŸ“± æ§åˆ¶è¨­å‚™å·²æ–·é–‹: ${conn.peer}`);
            });
        }
        
        // æ›´æ–°è¨­å‚™æ•¸é‡é¡¯ç¤º
        function updateDeviceCount() {
            const deviceCountElement = document.getElementById('deviceCount');
            if (deviceCountElement) {
                deviceCountElement.textContent = connections.size;
            }
        }
        
        // ç™¼é€ç•¶å‰è¨­å®šçµ¦é€£æ¥çš„è¨­å‚™
        function sendCurrentSettings(conn) {
            if (!conn || !conn.open) {
                console.warn('é€£æ¥ä¸å¯ç”¨ï¼Œç„¡æ³•ç™¼é€è¨­å®š');
                return;
            }
            
            const currentSettings = {
                fontSize: fontSize,
                scrollSpeed: scrollSpeed,
                textColor: textColor,
                backgroundColor: backgroundColor,
                mirrorMode: mirrorMode,
                totalLines: scriptLines.length,
                currentLine: currentLineIndex + 1,
                isPlaying: isPlaying,
                script: content ? content.textContent : ''
            };
            
            try {
                conn.send({
                    type: 'settings-sync',
                    data: currentSettings
                });
                console.log('è¨­å®šå·²åŒæ­¥åˆ°è¨­å‚™:', conn.peer);
            } catch (error) {
                console.error('ç™¼é€è¨­å®šå¤±æ•—:', error);
            }
        }
        
        // å»£æ’­æ¶ˆæ¯çµ¦æ‰€æœ‰é€£æ¥çš„è¨­å‚™
        function broadcastMessage(type, data) {
            const message = { type: type, data: data };
            connections.forEach((conn, peerId) => {
                if (conn && conn.open) {
                    conn.send(message);
                }
            });
        }
        
        // è™•ç†è¨Šæ¯
        function handleMessage(message, conn) {
            console.log('æ”¶åˆ°è¨Šæ¯:', message);
            
            switch (message.type) {
                case 'play-pause':
                    if (message.data.isPlaying) {
                        playScript();
                    } else {
                        pauseScript();
                    }
                    break;
                case 'play':
                    playScript();
                    break;
                case 'pause':
                    pauseScript();
                    break;
                case 'stop':
                    stopScript();
                    break;
                case 'speed-change':
                    changeSpeed(message.data.speed);
                    break;
                case 'font-change':
                    changeFontSize(message.data.fontSize);
                    break;
                case 'color-change':
                    if (message.data.textColor) setTextColor(message.data.textColor);
                    if (message.data.backgroundColor) setBackgroundColor(message.data.backgroundColor);
                    break;
                case 'mirror-change':
                    setMirror(message.data.mirrorMode);
                    break;
                case 'script-update':
                    updateScript(message.data.script);
                    break;
                case 'jump-to-line':
                    jumpToLine(message.data.line);
                    break;
                case 'previous-line':
                    previousLine();
                    break;
                case 'next-line':
                    nextLine();
                    break;
                case 'request-settings':
                    sendCurrentSettings(conn);
                    break;
            }
        }
        
        // å»£æ’­è¨Šæ¯çµ¦æ‰€æœ‰é€£æ¥çš„è¨­å‚™ï¼ˆç§»é™¤é‡è¤‡å®šç¾©ï¼‰
        
        // ç™¼é€è¨Šæ¯çµ¦ç‰¹å®šé€£æ¥
        function sendToConnection(conn, type, data) {
            try {
                conn.send({ type: type, data: data });
            } catch (error) {
                console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', error);
            }
        }
        
        // ç™¼é€ç•¶å‰è¨­å®šï¼ˆç§»é™¤é‡è¤‡å®šç¾©ï¼Œä½¿ç”¨ä¸Šé¢çš„ç‰ˆæœ¬ï¼‰
        
        // æ’­æ”¾æ§åˆ¶
        function playScript() {
            if (isPlaying || !content) {
                console.log('æ’­æ”¾å·²åœ¨é€²è¡Œä¸­æˆ–contentæœªåˆå§‹åŒ–');
                return;
            }
            
            isPlaying = true;
            updateConnectionStatus();
            console.log('é–‹å§‹æ’­æ”¾ï¼Œé€Ÿåº¦:', scrollSpeed);
            
            if (lineMode) {
                // è¡Œæ¨¡å¼ä¸‹ä¸è‡ªå‹•æ»¾å‹•
                console.log('è¡Œæ¨¡å¼ä¸‹ä¸è‡ªå‹•æ»¾å‹•');
                return;
            }
            
            // é€£çºŒæ»¾å‹•æ¨¡å¼ - ä¿®å¾©ç‰ˆæœ¬
            const scrollDistance = scrollSpeed * 0.5; // æ ¹æ“šé€Ÿåº¦èª¿æ•´ç§»å‹•è·é›¢
            const intervalTime = Math.max(16, 50 / scrollSpeed); // 60fpsæœ€å¤§ï¼Œæ ¹æ“šé€Ÿåº¦èª¿æ•´é–“éš”
            
            scrollAnimation = setInterval(() => {
                if (!content) {
                    console.error('æ»¾å‹•éç¨‹ä¸­contentä¸Ÿå¤±');
                    pauseScript();
                    return;
                }
                
                const currentTransform = content.style.transform || 'translateY(100vh)';
                let currentY;
                
                // æ­£ç¢ºè§£æç•¶å‰Yä½ç½®
                if (currentTransform.includes('translateY')) {
                    const match = currentTransform.match(/translateY\(([^)]+)\)/);
                    if (match) {
                        const value = match[1];
                        if (value.includes('vh')) {
                            currentY = window.innerHeight; // 100vh = è¦–çª—é«˜åº¦
                        } else {
                            currentY = parseFloat(value) || window.innerHeight;
                        }
                    } else {
                        currentY = window.innerHeight;
                    }
                } else {
                    currentY = window.innerHeight;
                }
                
                // å¾€ä¸Šæ»¾å‹•ï¼ˆæ¸›å°‘Yå€¼è®“å…§å®¹å¾€ä¸Šç§»å‹•ï¼‰
                const newY = currentY - scrollDistance;
                
                // åˆä½µæ»¾å‹•å’Œé¡åƒtransform
                let finalTransform = `translateY(${newY}px)`;
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    // æ­£å¸¸æ¨¡å¼ï¼šæ˜ç¢ºè¨­ç½®ç‚ºä¸ç¿»è½‰
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
                
                // å¦‚æœå…§å®¹å®Œå…¨æ»¾å‹•å‡ºè¦–çª—ä¸Šæ–¹ï¼Œåœæ­¢æ»¾å‹•ï¼ˆå¢åŠ æ›´å¤šç·©è¡ç©ºé–“ç¢ºä¿å…§å®¹å®Œå…¨é¡¯ç¤ºï¼‰
                if (newY < -content.offsetHeight - 500) {
                    stopScript();
                    showNotification('âœ… æè©å®Œæˆ');
                }
            }, intervalTime);
            
            // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™
            broadcastMessage('play-state', { isPlaying: true });
        }
        
        function pauseScript() {
            isPlaying = false;
            updateConnectionStatus();
            console.log('æš«åœæ’­æ”¾');
            
            if (scrollAnimation) {
                clearInterval(scrollAnimation);
                scrollAnimation = null;
            }
            
            // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™
            broadcastMessage('play-state', { isPlaying: false });
        }
        
        function stopScript() {
            console.log('åœæ­¢æ’­æ”¾ä¸¦é‡ç½®ä½ç½®');
            pauseScript();
            
            if (!content) {
                console.error('Contentæœªåˆå§‹åŒ–ï¼Œç„¡æ³•åœæ­¢');
                return;
            }
            
            // é‡ç½®åˆ°é–‹å§‹ä½ç½®ï¼Œä½†ä¿æŒé¡åƒæ¨¡å¼
            let finalTransform = 'translateY(100vh)';
            if (mirrorMode && mirrorMode !== 'none') {
                switch (mirrorMode) {
                    case 'horizontal':
                        finalTransform += ' scaleX(-1) scaleY(1)';
                        break;
                    case 'vertical':
                        finalTransform += ' scaleX(1) scaleY(-1)';
                        break;
                    case 'both':
                        finalTransform += ' scaleX(-1) scaleY(-1)';
                        break;
                }
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šæ˜ç¢ºè¨­ç½®ç‚ºä¸ç¿»è½‰
                finalTransform += ' scaleX(1) scaleY(1)';
            }
            content.style.transform = finalTransform;
            
            currentLineIndex = 0;
            
            if (lineMode) {
                displayCurrentLine();
            }
            
            // æ›´æ–°è¡Œè™Ÿé¡¯ç¤º
            updateLineNumbers();
            
            // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™
            broadcastMessage('stop-state', { reset: true });
        }
        
        // è¨­å®šæ§åˆ¶
        function changeSpeed(value) {
            scrollSpeed = parseFloat(value);
            document.getElementById('statusSpeed').textContent = scrollSpeed.toFixed(1);
            
            // æ›´æ–°è¨­å®šé¢æ¿ä¸­çš„é¡¯ç¤º
            const speedValue = document.getElementById('speedValue');
            if (speedValue) {
                speedValue.textContent = scrollSpeed.toFixed(1);
            }
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°é–‹å§‹ä»¥æ‡‰ç”¨æ–°é€Ÿåº¦
            if (isPlaying) {
                pauseScript();
                playScript();
            }
            
            // é€šçŸ¥é€£æ¥çš„è¨­å‚™
            broadcastMessage('speed-change', { speed: scrollSpeed });
        }
        
        function changeFontSize(value) {
            fontSize = parseInt(value);
            content.className = content.className.replace(/font-size-\d+/, `font-size-${fontSize}`);
            document.getElementById('statusFont').textContent = fontSize;
            
            // æ›´æ–°è¨­å®šé¢æ¿ä¸­çš„é¡¯ç¤º
            const fontSizeValue = document.getElementById('fontSizeValue');
            if (fontSizeValue) {
                fontSizeValue.textContent = fontSize;
            }
            
            // é‡æ–°è¨ˆç®—è¡Œæ•¸ä¸¦æ›´æ–°
            updateScriptLines();
            
            // å­—é«”å¤§å°æ”¹è®Šæ™‚éœ€è¦é‡æ–°è¨ˆç®—è¡Œè™Ÿé¡¯ç¤º
            setTimeout(updateLineNumbers, 100);
            
            // é€šçŸ¥é€£æ¥çš„è¨­å‚™
            broadcastMessage('font-size-change', { fontSize: fontSize });
        }
        
        function setTextColor(color) {
            textColor = color;
            content.style.color = color;
            updateColorSelection('textColorPicker', color);
            broadcastMessage('color-change', { textColor: color });
        }
        
        function setBackgroundColor(color) {
            backgroundColor = color;
            document.body.style.backgroundColor = color;
            updateColorSelection('bgColorPicker', color);
            broadcastMessage('color-change', { backgroundColor: color });
        }
        
        function setMirror(mode) {
            if (!content) {
                console.error('Content å…ƒç´ æœªåˆå§‹åŒ–ï¼Œç„¡æ³•è¨­ç½®é¡åƒæ¨¡å¼');
                return;
            }
            
            mirrorMode = mode || 'none';
            
            // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
            const mirrorNames = {
                'none': 'æ­£å¸¸',
                'horizontal': 'æ°´å¹³é¡åƒ',
                'vertical': 'å‚ç›´é¡åƒ',
                'both': 'é›™å‘é¡åƒ'
            };
            const statusMirror = document.getElementById('statusMirror');
            if (statusMirror) {
                statusMirror.textContent = mirrorNames[mode] || 'æ­£å¸¸';
            }
            
            // æ›´æ–°é¡åƒæŒ‰éˆ•ç‹€æ…‹
            updateMirrorButtons(mode);
            
            // é‡æ–°æ‡‰ç”¨transformï¼ˆåŒ…å«ç•¶å‰çš„æ»¾å‹•ä½ç½®ï¼‰
            const currentTransform = content.style.transform || 'translateY(100vh)';
            let translateY = 'translateY(100vh)';
            
            // æå–ç•¶å‰çš„translateYå€¼
            if (currentTransform.includes('translateY')) {
                const match = currentTransform.match(/translateY\([^)]+\)/);
                if (match) {
                    translateY = match[0];
                } else {
                    translateY = 'translateY(100vh)';
                }
            }
            
            // æ§‹å»ºæ–°çš„transform - ç¢ºä¿æ­£å¸¸æ¨¡å¼ä¸‹æ˜ç¢ºè¨­ç½®scaleç‚º1
            let finalTransform = translateY;
            if (mode && mode !== 'none') {
                switch (mode) {
                    case 'horizontal':
                        finalTransform += ' scaleX(-1) scaleY(1)';
                        break;
                    case 'vertical':
                        finalTransform += ' scaleX(1) scaleY(-1)';
                        break;
                    case 'both':
                        finalTransform += ' scaleX(-1) scaleY(-1)';
                        break;
                }
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šæ˜ç¢ºè¨­ç½®ç‚ºä¸ç¿»è½‰
                finalTransform += ' scaleX(1) scaleY(1)';
            }
            
            content.style.transform = finalTransform;
            console.log(`é¡åƒæ¨¡å¼å·²è¨­ç½®ç‚º: ${mode}, transform: ${finalTransform}`);
            
            // é€šçŸ¥é€£æ¥çš„è¨­å‚™
            broadcastMessage('mirror-change', { mirrorMode: mode });
        }
        
        function updateScript(scriptText) {
            content.textContent = scriptText;
            updateScriptLines();
        }
        
        // æ‰‹å‹•è¡Œæ§åˆ¶
        function updateScriptLines() {
            if (!content) {
                console.log('contentå…ƒç´ æœªåˆå§‹åŒ–');
                return;
            }
            
            // ç²å–æ–‡æœ¬å…§å®¹ï¼ˆè™•ç†HTMLå’Œç´”æ–‡æœ¬ï¼‰
            let scriptText = '';
            if (content.innerHTML.includes('<br>')) {
                // å¦‚æœåŒ…å«<br>æ¨™ç±¤ï¼Œå°‡å…¶è½‰æ›ç‚ºæ›è¡Œç¬¦
                scriptText = content.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
            } else {
                // å¦å‰‡ç›´æ¥ä½¿ç”¨textContent
                scriptText = content.textContent || content.innerText || '';
            }
            
            console.log('åŸå§‹æ–‡ç¨¿å…§å®¹:', scriptText);
            
            // æŒ‰è¡Œåˆ†å‰²ï¼Œä¿ç•™æ‰€æœ‰è¡Œï¼ˆåŒ…æ‹¬ç©ºè¡Œä»¥ç¶­æŒæ®µè½æ ¼å¼ï¼‰
            scriptLines = scriptText.split(/\r?\n/);
            
            console.log('åˆ†å‰²å¾Œçš„è¡Œæ•¸:', scriptLines.length);
            console.log('å‰10è¡Œå…§å®¹:', scriptLines.slice(0, 10));
            console.log('ç¸½å­—æ•¸:', scriptText.length);
            
            // æ›´æ–°è¡Œæ•¸é¡¯ç¤º
            updateLineDisplays();
            
            // æ›´æ–°è¡Œè™Ÿé¡¯ç¤º
            updateLineNumbers();
            
            // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™ï¼Œç™¼é€å‰100è¡Œåˆ°æ§åˆ¶é¢æ¿
            const first100Lines = scriptLines.slice(0, 100).join('\n');
            broadcastMessage('script-content', { 
                script: first100Lines,
                totalLines: scriptLines.length,
                fullContent: scriptText // ç™¼é€å®Œæ•´å…§å®¹ç”¨æ–¼å‚™ä»½
            });
            broadcastMessage('total-lines', { totalLines: scriptLines.length });
            
            console.log('æ–‡ç¨¿æ›´æ–°ï¼Œç¸½å…±', scriptLines.length, 'è¡Œï¼ŒåŒæ­¥å‰100è¡Œåˆ°æ§åˆ¶é¢æ¿');
        }
        
        // æ›´æ–°è¡Œè™Ÿé¡¯ç¤º
        function updateLineNumbers() {
            const lineNumbersContainer = document.getElementById('lineNumbers');
            if (!lineNumbersContainer) {
                console.warn('æ‰¾ä¸åˆ°è¡Œè™Ÿå®¹å™¨');
                return;
            }
            
            // æ¸…ç©ºç¾æœ‰è¡Œè™Ÿ
            lineNumbersContainer.innerHTML = '';
            
            // å¦‚æœæ²’æœ‰æ–‡ç¨¿å…§å®¹ï¼Œä¸é¡¯ç¤ºè¡Œè™Ÿ
            if (!scriptLines || scriptLines.length === 0) {
                console.log('ç„¡æ–‡ç¨¿å…§å®¹ï¼Œéš±è—è¡Œè™Ÿ');
                return;
            }
            
            const totalLines = scriptLines.length;
            const currentLine = currentLineIndex + 1;
            
            console.log('æ›´æ–°è¡Œè™Ÿé¡¯ç¤º - ç¸½è¡Œæ•¸:', totalLines, 'ç•¶å‰è¡Œ:', currentLine);
            
            // åªæœ‰åœ¨æœ‰å¯¦éš›å…§å®¹æ™‚æ‰é¡¯ç¤ºè¡Œè™Ÿ
            if (totalLines > 0) {
                // é¡¯ç¤ºç•¶å‰è¡Œå‰å¾Œå„5è¡Œï¼Œç¸½å…±æœ€å¤š11è¡Œ
                const displayRange = 5;
                let startLine = Math.max(1, currentLine - displayRange);
                let endLine = Math.min(totalLines, currentLine + displayRange);
                
                // ç¢ºä¿è‡³å°‘é¡¯ç¤º11è¡Œï¼ˆå¦‚æœç¸½è¡Œæ•¸è¶³å¤ ï¼‰
                const minDisplayLines = Math.min(11, totalLines);
                if (endLine - startLine + 1 < minDisplayLines) {
                    if (startLine === 1) {
                        endLine = Math.min(totalLines, startLine + minDisplayLines - 1);
                    } else if (endLine === totalLines) {
                        startLine = Math.max(1, endLine - minDisplayLines + 1);
                    }
                }
                
                // ç”Ÿæˆè¡Œè™Ÿ
                for (let i = startLine; i <= endLine; i++) {
                    const lineNumberDiv = document.createElement('div');
                    lineNumberDiv.className = 'line-number';
                    lineNumberDiv.textContent = i;
                    lineNumberDiv.style.opacity = (i === currentLine) ? '1' : '0.5';
                    lineNumberDiv.style.fontWeight = (i === currentLine) ? 'bold' : 'normal';
                    lineNumberDiv.style.color = (i === currentLine) ? '#fff' : 'rgba(255, 255, 255, 0.5)';
                    
                    lineNumbersContainer.appendChild(lineNumberDiv);
                }
                
                console.log(`è¡Œè™Ÿæ›´æ–°: é¡¯ç¤º ${startLine}-${endLine}ï¼Œç•¶å‰è¡Œ ${currentLine}ï¼Œç¸½è¡Œæ•¸ ${totalLines}`);
            }
        }
        
        function jumpToLine(lineNumber) {
            if (lineNumber < 1 || lineNumber > scriptLines.length) {
                console.log('è¡Œè™Ÿè¶…å‡ºç¯„åœ:', lineNumber);
                return;
            }
            
            currentLineIndex = lineNumber - 1;
            enterManualMode();
            displayCurrentLine();
            
            // æ›´æ–°é¡¯ç¤º
            updateLineDisplays();
            
            // é€šçŸ¥æ§åˆ¶è¨­å‚™
            broadcastMessage('current-line-update', { 
                currentLine: currentLineIndex + 1,
                totalLines: scriptLines.length 
            });
        }
        
        // å¾è¼¸å…¥æ¡†è·³è½‰åˆ°æŒ‡å®šè¡Œ
        function jumpToLineFromInput() {
            const input = document.getElementById('jumpToLineInput');
            if (input && input.value) {
                const lineNumber = parseInt(input.value);
                jumpToLine(lineNumber);
            }
        }
        
        // æ›´æ–°è¡Œæ•¸é¡¯ç¤º
        function updateLineDisplays() {
            const currentLineDisplay = document.getElementById('currentLineDisplay');
            const totalLinesDisplay = document.getElementById('totalLinesDisplay');
            
            if (currentLineDisplay) {
                currentLineDisplay.textContent = currentLineIndex + 1;
            }
            if (totalLinesDisplay) {
                totalLinesDisplay.textContent = scriptLines.length;
            }
            
            // åŒæ™‚æ›´æ–°è¡Œè™Ÿé¡¯ç¤º
            updateLineNumbers();
        }
        
        function previousLine() {
            if (currentLineIndex > 0) {
                currentLineIndex--;
                enterManualMode();
                displayCurrentLine();
                updateLineDisplays();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        function nextLine() {
            if (currentLineIndex < scriptLines.length - 1) {
                currentLineIndex++;
                enterManualMode();
                displayCurrentLine();
                updateLineDisplays();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        // é€²å…¥æ‰‹å‹•æ¨¡å¼
        function enterManualMode() {
            if (!manualMode) {
                manualMode = true;
                lineMode = true;
                
                // åœæ­¢è‡ªå‹•æ’­æ”¾
                if (isPlaying) {
                    pauseScript();
                }
                
                // æ›´æ–°UIç‹€æ…‹
                updatePlaybackModeDisplay();
                enableManualControls();
                
                console.log('é€²å…¥æ‰‹å‹•æ’­æ”¾æ¨¡å¼');
                broadcastMessage('manual-mode', { enabled: true });
            }
        }
        
        // å¾ç•¶å‰è¡Œç¹¼çºŒæè©
        function continueFromCurrentLine() {
            if (!manualMode || scriptLines.length === 0) return;
            
            console.log('å¾ç¬¬', currentLineIndex + 1, 'è¡Œç¹¼çºŒæè©');
            
            // è¨­ç½®å…§å®¹åˆ°ç•¶å‰è¡Œä½ç½®ä¸¦é–‹å§‹æ»¾å‹•æè©
            displayCurrentLine();
            
            // é–‹å§‹è‡ªå‹•æ»¾å‹•ï¼ˆä½†ä¿æŒåœ¨æ‰‹å‹•æ¨¡å¼ï¼‰
            isPlaying = true;
            updateConnectionStatus();
            
            const scrollDistance = scrollSpeed * 0.5;
            const intervalTime = Math.max(16, 50 / scrollSpeed);
            
            scrollAnimation = setInterval(() => {
                if (!content) {
                    console.error('æ»¾å‹•éç¨‹ä¸­contentä¸Ÿå¤±');
                    pauseManualMode();
                    return;
                }
                
                const currentTransform = content.style.transform || 'translateY(20vh)';
                let currentY = 20 * window.innerHeight / 100; // 20vhè½‰æ›ç‚ºpx
                
                if (currentTransform.includes('translateY')) {
                    const match = currentTransform.match(/translateY\(([^)]+)\)/);
                    if (match) {
                        const value = match[1];
                        if (value.includes('vh')) {
                            currentY = parseFloat(value) * window.innerHeight / 100;
                        } else {
                            currentY = parseFloat(value) || 20 * window.innerHeight / 100;
                        }
                    }
                }
                
                const newY = currentY - scrollDistance;
                
                let finalTransform = `translateY(${newY}px)`;
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
                
                // æª¢æŸ¥æ˜¯å¦æ»¾å‹•å®Œç•¢
                if (newY < -content.offsetHeight - 500) {
                    pauseManualMode();
                    showNotification('âœ… æ‰‹å‹•æè©å®Œæˆ');
                }
            }, intervalTime);
            
            broadcastMessage('manual-continue', { fromLine: currentLineIndex + 1 });
        }
        
        // æš«åœæ‰‹å‹•æ¨¡å¼
        function pauseManualMode() {
            isPlaying = false;
            updateConnectionStatus();
            
            if (scrollAnimation) {
                clearInterval(scrollAnimation);
                scrollAnimation = null;
            }
            
            console.log('æ‰‹å‹•æ¨¡å¼æš«åœ');
            broadcastMessage('manual-pause', {});
        }
        
        // å›åˆ°è‡ªå‹•æ¨¡å¼
        function returnToAutoMode() {
            console.log('å›åˆ°è‡ªå‹•æ¨¡å¼');
            
            // åœæ­¢æ‰‹å‹•æ’­æ”¾
            pauseManualMode();
            
            // é‡ç½®ç‹€æ…‹
            manualMode = false;
            lineMode = false;
            currentLineIndex = 0;
            
            // é‡ç½®å…§å®¹é¡¯ç¤º
            if (content) {
                const scriptContent = document.getElementById('scriptEditor').value;
                if (scriptContent.trim()) {
                    content.innerHTML = scriptContent.replace(/\n/g, '<br>');
                } else {
                    content.innerHTML = 'æ­¡è¿ä½¿ç”¨æ™ºæ…§æè©æ©Ÿ<br>è«‹é–‹å•Ÿæ§åˆ¶é¢æ¿è¨­å®šæ–‡ç¨¿å…§å®¹<br><br>å¿«æ·éµï¼š<br>â€¢ ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ<br>â€¢ ESCï¼šé¡¯ç¤ºè¨­å®š<br>â€¢ â†‘â†“ï¼šèª¿æ•´é€Ÿåº¦<br>â€¢ â†â†’ï¼šèª¿æ•´å­—é«”';
                }
                
                // é‡ç½®åˆ°é–‹å§‹ä½ç½®
                let finalTransform = 'translateY(100vh)';
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
            }
            
            // æ›´æ–°UIç‹€æ…‹
            updatePlaybackModeDisplay();
            disableManualControls();
            updateScriptLines();
            updateLineNumbers();
            updateLineDisplays();
            
            showNotification('ğŸ”„ å·²å›åˆ°è‡ªå‹•æ¨¡å¼');
            broadcastMessage('auto-mode', { enabled: true });
        }
        
        // æ›´æ–°æ’­æ”¾æ¨¡å¼é¡¯ç¤º
        function updatePlaybackModeDisplay() {
            const modeDisplay = document.getElementById('playbackModeDisplay');
            if (modeDisplay) {
                modeDisplay.textContent = manualMode ? 'æ‰‹å‹•æ¨¡å¼' : 'è‡ªå‹•æ¨¡å¼';
                modeDisplay.style.color = manualMode ? '#ff9800' : '#4CAF50';
            }
        }
        
        // å•Ÿç”¨æ‰‹å‹•æ§åˆ¶æŒ‰éˆ•
        function enableManualControls() {
            const continueBtn = document.getElementById('continueBtn');
            const pauseManualBtn = document.getElementById('pauseManualBtn');
            const returnAutoBtn = document.getElementById('returnAutoBtn');
            
            if (continueBtn) continueBtn.disabled = false;
            if (pauseManualBtn) pauseManualBtn.disabled = false;
            if (returnAutoBtn) returnAutoBtn.disabled = false;
        }
        
        // åœç”¨æ‰‹å‹•æ§åˆ¶æŒ‰éˆ•
        function disableManualControls() {
            const continueBtn = document.getElementById('continueBtn');
            const pauseManualBtn = document.getElementById('pauseManualBtn');
            const returnAutoBtn = document.getElementById('returnAutoBtn');
            
            if (continueBtn) continueBtn.disabled = true;
            if (pauseManualBtn) pauseManualBtn.disabled = true;
            if (returnAutoBtn) returnAutoBtn.disabled = true;
        }
        
        // æ›´æ–°é¡åƒæŒ‰éˆ•ç‹€æ…‹
        function updateMirrorButtons(mode) {
            // ç§»é™¤æ‰€æœ‰æŒ‰éˆ•çš„activeç‹€æ…‹
            ['none', 'horizontal', 'vertical', 'both'].forEach(m => {
                const btn = document.getElementById(`mirrorBtn-${m}`);
                if (btn) {
                    btn.classList.remove('active');
                }
            });
            
            // æ·»åŠ ç•¶å‰æ¨¡å¼æŒ‰éˆ•çš„activeç‹€æ…‹
            const activeBtn = document.getElementById(`mirrorBtn-${mode}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            console.log('é¡åƒæŒ‰éˆ•ç‹€æ…‹å·²æ›´æ–°:', mode);
        }
        
        // æ–‡ç¨¿æ­·å²åŠŸèƒ½
        function saveCurrentScript() {
            const scriptText = document.getElementById('scriptEditor').value;
            if (!scriptText.trim()) {
                showNotification('âš ï¸ æ–‡ç¨¿å…§å®¹ç‚ºç©ºï¼Œç„¡æ³•ä¿å­˜');
                return;
            }
            
            const history = getScriptHistory();
            const timestamp = new Date().toLocaleString();
            const preview = scriptText.substring(0, 50) + (scriptText.length > 50 ? '...' : '');
            
            const newScript = {
                id: Date.now(),
                content: scriptText,
                timestamp: timestamp,
                preview: preview
            };
            
            history.unshift(newScript);
            
            // é™åˆ¶æ­·å²è¨˜éŒ„æ•¸é‡
            if (history.length > 10) {
                history.splice(10);
            }
            
            localStorage.setItem('teleprompter-main-script-history', JSON.stringify(history));
            loadScriptHistory();
            showNotification('âœ… æ–‡ç¨¿å·²ä¿å­˜åˆ°æ­·å²è¨˜éŒ„');
        }
        
        function getScriptHistory() {
            try {
                const history = localStorage.getItem('teleprompter-main-script-history');
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('è¼‰å…¥æ–‡ç¨¿æ­·å²å¤±æ•—:', error);
                return [];
            }
        }
        
        function loadScriptHistory() {
            const historyContainer = document.getElementById('scriptHistory');
            if (!historyContainer) return;
            
            const history = getScriptHistory();
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p style="color: #ccc; font-size: 12px;">æš«ç„¡æ–‡ç¨¿æ­·å²</p>';
                return;
            }
            
            historyContainer.innerHTML = history.map(script => `
                <div class="script-item">
                    <div class="script-preview">${script.preview}</div>
                    <div class="script-timestamp">${script.timestamp}</div>
                    <div class="script-actions">
                        <button onclick="loadScript(${script.id})" class="btn-small">è¼‰å…¥</button>
                        <button onclick="deleteScript(${script.id})" class="btn-small delete-btn">åˆªé™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function loadScript(scriptId) {
            const history = getScriptHistory();
            const script = history.find(s => s.id === scriptId);
            
            if (script) {
                document.getElementById('scriptEditor').value = script.content;
                showNotification('âœ… æ–‡ç¨¿å·²è¼‰å…¥');
            }
        }
        
        function deleteScript(scriptId) {
            const history = getScriptHistory().filter(s => s.id !== scriptId);
            localStorage.setItem('teleprompter-main-script-history', JSON.stringify(history));
            loadScriptHistory();
            showNotification('ğŸ—‘ï¸ æ–‡ç¨¿å·²åˆªé™¤');
        }
        
        function clearScriptHistory() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ–‡ç¨¿æ­·å²å—ï¼Ÿ')) {
                localStorage.removeItem('teleprompter-main-script-history');
                loadScriptHistory();
                showNotification('ğŸ—‘ï¸ æ–‡ç¨¿æ­·å²å·²æ¸…ç©º');
            }
        }
        
        function displayCurrentLine() {
            if (scriptLines.length === 0) return;
            
            // é¡¯ç¤ºç•¶å‰è¡ŒåŠå‰å¾Œæ–‡
            const contextLines = 3;
            const startIndex = Math.max(0, currentLineIndex - contextLines);
            const endIndex = Math.min(scriptLines.length, currentLineIndex + contextLines + 1);
            
            let displayText = '';
            for (let i = startIndex; i < endIndex; i++) {
                const line = scriptLines[i];
                if (i === currentLineIndex) {
                    displayText += `<span class="current-line-highlight">${line}</span>\n`;
                } else {
                    const opacity = Math.abs(i - currentLineIndex) <= 1 ? 1 : 0.6;
                    displayText += `<span style="opacity: ${opacity};">${line}</span>\n`;
                }
            }
            
            content.innerHTML = displayText;
            
            // é‡ç½®æ»¾å‹•ä½ç½®ä»¥ç¢ºä¿ç•¶å‰è¡Œå¯è¦‹
            content.style.transform = 'translateY(20vh)';
        }
        
        // éµç›¤å¿«æ·éµ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (isPlaying) {
                            pauseScript();
                        } else {
                            playScript();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        toggleHelp();
                        break;
                    case 'KeyS':
                        e.preventDefault();
                        stopScript();
                        break;
                    case 'KeyF':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        changeSpeed(Math.min(5.0, scrollSpeed + 0.1));
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        changeSpeed(Math.max(0.1, scrollSpeed - 0.1));
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        changeFontSize(Math.max(1, fontSize - 1));
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        changeFontSize(Math.min(10, fontSize + 1));
                        break;
                }
            });
        }
        
        // æ›´æ–°æˆ¿é–“IDé¡¯ç¤ºï¼ˆä¸é‡æ–°ç”ŸæˆroomIdï¼‰
        function updateRoomDisplay() {
            const roomDisplay = document.getElementById('currentRoomId');
            if (roomDisplay && roomId) {
                roomDisplay.textContent = roomId;
                console.log('æˆ¿é–“IDå·²æ›´æ–°é¡¯ç¤º:', roomId);
            }
        }
        
        // è¨­å®šé¢æ¿æ§åˆ¶
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            if (panel) {
                // ä½¿ç”¨CSSé¡åˆ¥ä¾†æ§åˆ¶é¢æ¿é¡¯ç¤º
                const isOpen = panel.classList.contains('open');
                if (isOpen) {
                    panel.classList.remove('open');
                    console.log('è¨­å®šé¢æ¿å·²é—œé–‰');
                } else {
                    panel.classList.add('open');
                    console.log('è¨­å®šé¢æ¿å·²é–‹å•Ÿ');
                }
            } else {
                console.error('æ‰¾ä¸åˆ°è¨­å®šé¢æ¿å…ƒç´ ');
            }
        }
        
        // æ‡‰ç”¨æ–‡ç¨¿åˆ°ä¸»ç•«é¢
        function applyScript() {
            const scriptContent = document.getElementById('scriptEditor').value;
            if (scriptContent.trim()) {
                console.log('æ‡‰ç”¨æ–‡ç¨¿:', scriptContent.substring(0, 100) + '...');
                
                // æ›´æ–°ä¸»é¡¯ç¤ºå…§å®¹
                content.innerHTML = scriptContent.replace(/\n/g, '<br>');
                
                // é‡æ–°åˆå§‹åŒ–è¡Œæ•¸çµ±è¨ˆ
                updateScriptLines();
                updateLineNumbers();
                
                // é‡ç½®åˆ°é–‹å§‹ä½ç½®ï¼Œä¿æŒç•¶å‰é¡åƒæ¨¡å¼
                let finalTransform = 'translateY(100vh)';
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
                currentLineIndex = 0;
                
                showNotification('âœ… æ–‡ç¨¿å·²æ‡‰ç”¨åˆ°ä¸»ç•«é¢');
                
                // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™
                broadcastMessage('script-update', { script: scriptContent });
            } else {
                showNotification('âŒ è«‹å…ˆè¼¸å…¥æ–‡ç¨¿å…§å®¹');
            }
        }
        
        // è¨­å®šæ»¾å‹•é€Ÿåº¦
        function setScrollSpeed(speed) {
            scrollSpeed = parseFloat(speed);
            document.getElementById('statusSpeed').textContent = scrollSpeed.toFixed(1);
            
            // æ›´æ–°æ»‘å¡Šé¡¯ç¤º
            const speedSlider = document.getElementById('speedSlider');
            const speedValueDisplay = document.getElementById('speedValue');
            if (speedSlider) speedSlider.value = scrollSpeed;
            if (speedValueDisplay) speedValueDisplay.textContent = scrollSpeed.toFixed(1);
            
            // é€šçŸ¥é€£æ¥çš„è¨­å‚™
            broadcastMessage('speed-change', { speed: scrollSpeed });
        }
        
        // è¨­å®šå­—é«”å¤§å°
        function setFontSize(size) {
            fontSize = parseInt(size);
            changeFontSize(fontSize);
            
            // æ›´æ–°æ»‘å¡Šé¡¯ç¤º
            const fontSlider = document.getElementById('fontSlider');
            const fontValueDisplay = document.getElementById('fontSizeValue');
            if (fontSlider) fontSlider.value = fontSize;
            if (fontValueDisplay) fontValueDisplay.textContent = fontSize;
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            
            if (isConnected) {
                statusElement.innerHTML = 'ğŸŸ¢ åœ¨ç·š';
            } else {
                statusElement.innerHTML = 'ğŸ”´ é›¢ç·š';
            }
        }
        
        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = connections.size;
        }
        
        function toggleHelp() {
            const helpOverlay = document.getElementById('helpOverlay');
            helpOverlay.classList.toggle('show');
        }
        
        function hideHelp() {
            document.getElementById('helpOverlay').classList.remove('show');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function loadSettings() {
            try {
                // å¾ localStorage è¼‰å…¥è¨­å®š
                const savedSettings = localStorage.getItem('teleprompter-settings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    console.log('è¼‰å…¥å·²ä¿å­˜çš„è¨­å®š:', settings);
                    
                    if (settings.textColor) setTextColor(settings.textColor);
                    if (settings.backgroundColor) setBackgroundColor(settings.backgroundColor);
                    if (settings.fontSize) changeFontSize(settings.fontSize);
                    if (settings.scrollSpeed) changeSpeed(settings.scrollSpeed);
                    
                    // é¡åƒæ¨¡å¼ç‰¹åˆ¥è™•ç†ï¼Œç¢ºä¿é è¨­ç‚º 'none'
                    if (settings.mirrorMode && settings.mirrorMode !== 'none') {
                        setMirror(settings.mirrorMode);
                    } else {
                        setMirror('none');
                    }
                } else {
                    console.log('æ²’æœ‰å·²ä¿å­˜çš„è¨­å®šï¼Œä½¿ç”¨é è¨­å€¼');
                    // ç¢ºä¿ä½¿ç”¨é è¨­å€¼
                    setMirror('none');
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨­å®šæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // ä½¿ç”¨é è¨­å€¼
                setMirror('none');
            }
        }
        
        function saveSettings() {
            const settings = {
                textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode
            };
            localStorage.setItem('teleprompter-settings', JSON.stringify(settings));
        }
        
        // é é¢é—œé–‰å‰ä¿å­˜è¨­å®š
        window.addEventListener('beforeunload', saveSettings);
        
        // ç§»é™¤é‡è¤‡çš„å‡½æ•¸å®šç¾©ï¼ˆå·²åœ¨å‰é¢å®šç¾©ï¼‰
        
        // é¡è‰²é è¨­
        const COMMON_COLORS = [
            '#FFFFFF', '#F5F5F5', '#EEEEEE', '#DDDDDD', '#BBBBBB', '#999999', '#666666', '#000000',
            '#FFFEF7', '#FFF8DC', '#FFFFE0', '#FFFF99', '#FFFF00', '#FFD700', '#FFA500', '#FF8C00',
            '#FFEEE6', '#FFCC99', '#FFB366', '#FF9933', '#FF7F00', '#FF6347', '#D2691E', '#8B4513',
            '#FFE4E1', '#FFB6C1', '#FF69B4', '#FF1493', '#DC143C', '#B22222', '#8B0000', '#4B0000',
            '#E6F3FF', '#87CEEB', '#00BFFF', '#1E90FF', '#0066CC', '#003399', '#191970', '#000080',
            '#E6FFE6', '#90EE90', '#00FF00', '#32CD32', '#20B2AA', '#228B22', '#006400', '#013220',
            '#F0E6FF', '#DDA0DD', '#BA55D3', '#9932CC', '#8A2BE2', '#663399', '#4B0082', '#2E004B'
        ];
        
        // å»ºç«‹é¡è‰²é¸æ“‡å™¨ï¼ˆé˜²æ­¢é‡è¤‡å‰µå»ºï¼‰
        function createColorPickers() {
            const textPicker = document.getElementById('textColorPicker');
            const bgPicker = document.getElementById('bgColorPicker');
            
            if (textPicker && bgPicker) {
                // æ¸…ç©ºç¾æœ‰å…§å®¹ï¼Œé˜²æ­¢é‡è¤‡æ·»åŠ 
                textPicker.innerHTML = '';
                bgPicker.innerHTML = '';
                
                COMMON_COLORS.forEach(color => {
                    // æ–‡å­—é¡è‰²é¸æ“‡å™¨
                    const textOption = document.createElement('div');
                    textOption.className = 'color-option';
                    textOption.style.backgroundColor = color;
                    textOption.onclick = () => {
                        setTextColor(color);
                        updateColorSelection('textColorPicker', color);
                    };
                    textOption.title = color;
                    textPicker.appendChild(textOption);
                    
                    // èƒŒæ™¯é¡è‰²é¸æ“‡å™¨
                    const bgOption = document.createElement('div');
                    bgOption.className = 'color-option';
                    bgOption.style.backgroundColor = color;
                    bgOption.onclick = () => {
                        setBackgroundColor(color);
                        updateColorSelection('bgColorPicker', color);
                    };
                    bgOption.title = color;
                    bgPicker.appendChild(bgOption);
                });
            }
        }
        
        // æ›´æ–°é¡è‰²é¸æ“‡ç‹€æ…‹
        function updateColorSelection(pickerId, selectedColor) {
            const picker = document.getElementById(pickerId);
            if (!picker) return;
            
            picker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.style.backgroundColor === selectedColor ||
                    option.title === selectedColor) {
                    option.classList.add('selected');
                }
            });
        }
        
        // æ›´æ–°é€Ÿåº¦é¡¯ç¤º
        function updateSpeedDisplay() {
            const speedValue = document.getElementById('speedValue');
            if (speedValue) {
                speedValue.textContent = scrollSpeed.toFixed(1);
            }
        }
        
        // æ›´æ–°å­—é«”å¤§å°é¡¯ç¤º
        function updateFontSizeDisplay() {
            const fontSizeValue = document.getElementById('fontSizeValue');
            if (fontSizeValue) {
                fontSizeValue.textContent = fontSize;
            }
        }
        
        // ä¿®æ”¹changeSpeedå‡½æ•¸ä»¥æ›´æ–°é¡¯ç¤º
        const originalChangeSpeed = changeSpeed;
        changeSpeed = function(speed) {
            originalChangeSpeed(speed);
            updateSpeedDisplay();
        };
        
        // ä¿®æ”¹changeFontSizeå‡½æ•¸ä»¥æ›´æ–°é¡¯ç¤º
        const originalChangeFontSize = changeFontSize;
        changeFontSize = function(size) {
            originalChangeFontSize(size);
            updateFontSizeDisplay();
        };
        
        // åˆå§‹åŒ–è¨­å®šé¢æ¿
        function initializeSettings() {
            createColorPickers();
            updateSpeedDisplay();
            updateFontSizeDisplay();
            updateColorSelection('textColorPicker', textColor);
            updateColorSelection('bgColorPicker', backgroundColor);
            
            // åˆå§‹åŒ–æ’­æ”¾æ¨¡å¼é¡¯ç¤º
            updatePlaybackModeDisplay();
            disableManualControls();
            
            // åˆå§‹åŒ–é¡åƒæŒ‰éˆ•ç‹€æ…‹
            updateMirrorButtons(mirrorMode);
            
            // åŒæ­¥æ»‘å‹•æ¢ä½ç½®
            const speedSlider = document.getElementById('speedSlider');
            const fontSizeSlider = document.getElementById('fontSizeSlider');
            
            if (speedSlider) {
                speedSlider.value = scrollSpeed;
            }
            if (fontSizeSlider) {
                fontSizeSlider.value = fontSize;
            }
            
            // è¼‰å…¥æ–‡ç¨¿æ­·å²
            loadScriptHistory();
            
            // æ›´æ–°è¡Œæ•¸é¡¯ç¤º
            updateLineDisplays();
        }
        
        // åˆå§‹åŒ–è¡Œæ•¸çµ±è¨ˆ
        window.addEventListener('load', function() {
            // ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²è¼‰å…¥
            setTimeout(() => {
                console.log('é é¢è¼‰å…¥å®Œæˆï¼Œåˆå§‹åŒ–ç³»çµ±');
                updateScriptLines();
                initializeSettings();
                
                // ç¢ºä¿é¡åƒæ¨¡å¼ç‚ºé è¨­å€¼
                if (mirrorMode !== 'none') {
                    setMirror('none');
                }
                
                // é¡¯ç¤ºåˆå§‹åŒ–å®Œæˆé€šçŸ¥
                showNotification('âœ… æ™ºæ…§æè©æ©Ÿå·²åˆå§‹åŒ–å®Œæˆ');
            }, 500);
        });
        
        // é€šçŸ¥ç³»çµ±
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // æ·»åŠ é€šçŸ¥å‹•ç•«æ¨£å¼
        const notificationStyle = document.createElement('style');
        notificationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(notificationStyle);
    </script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</body>
</html>
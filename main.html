<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧提詞機 - 主顯示器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            background: #000;
            color: #fff;
            position: relative;
        }
        
        /* 提詞機容器 */
        .teleprompter-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 行號顯示 */
        .line-numbers {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1vh;
            font-size: 2vh;
            color: rgba(255, 255, 255, 0.3);
            font-family: monospace;
            z-index: 10;
            line-height: 1.6;
        }
        
        .line-number {
            padding: 0.2em 0.5em;
            border-radius: 0.3em;
            background: rgba(255, 255, 255, 0.05);
            min-width: 3em;
            text-align: center;
            transition: all 0.3s;
        }
        
        .line-number.current {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
        }
        
        .teleprompter-content {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 1.6;
            padding: 2rem;
            transform: translateY(100vh);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 10個字體大小等級 */
        .font-size-1 { font-size: 3vh; }
        .font-size-2 { font-size: 4vh; }
        .font-size-3 { font-size: 5vh; }
        .font-size-4 { font-size: 6.5vh; }
        .font-size-5 { font-size: 8vh; }
        .font-size-6 { font-size: 10vh; }
        .font-size-7 { font-size: 13vh; }
        .font-size-8 { font-size: 16vh; }
        .font-size-9 { font-size: 20vh; }
        .font-size-10 { font-size: 25vh; }
        
        /* 鏡像效果 - 只通過JavaScript內聯樣式應用，避免CSS衝突 */
        .mirror-horizontal { transform: scaleX(-1) !important; }
        .mirror-vertical { transform: scaleY(-1) !important; }
        .mirror-both { transform: scale(-1, -1) !important; }
        
        /* 狀態顯示 */
        .status-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .room-id-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            z-index: 1000;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* 快捷鍵提示 */
        .help-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 2000;
        }
        
        .help-overlay.show {
            display: block;
        }
        
        /* 行高亮樣式 */
        .current-line-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0.2em;
            border-radius: 0.3em;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .teleprompter-content {
                padding: 1rem;
            }
            
            .status-bar, .room-id-display, .connection-status {
                font-size: 10px;
                padding: 8px 12px;
            }
        }
        
        /* 設定按鈕 */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #666;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .settings-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: #999;
        }
        
        /* 設定面板 */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: 100vh;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            border-left: 2px solid #444;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        /* 設定面板內容樣式 */
        .setting-group {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(50, 50, 50, 0.8);
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        
        .setting-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #222;
            color: white;
            font-size: 14px;
        }
        
        .slider-group {
            margin-bottom: 20px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .slider-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        /* 鏡像按鈕活動狀態 */
        .btn.active {
            background: #28a745 !important;
            color: white !important;
        }
        
        /* 文稿歷史樣式 */
        .script-history {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
        }
        
        .script-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .script-item:last-child {
            margin-bottom: 0;
        }
        
        .script-preview {
            font-size: 12px;
            color: #fff;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .script-timestamp {
            font-size: 10px;
            color: #ccc;
            margin-bottom: 8px;
        }
        
        .script-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-small:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-small.delete-btn {
            background: rgba(244, 67, 54, 0.6);
        }
        
        .btn-small.delete-btn:hover {
            background: rgba(244, 67, 54, 0.8);
        }
        
        /* 顏色選擇器 */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 100%;
            height: 24px;
            border: 2px solid #666;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .color-option:hover {
            transform: scale(1.05);
            border-color: #fff;
        }
        
        .color-option.selected {
            border-color: #2196F3;
            border-width: 3px;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        }
        
        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* 鏡像模式現在使用內聯樣式處理，以兼容滾動動畫 */
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- 狀態列 -->
    <div class="status-bar">
        <div>📺 主顯示器</div>
        <div>速度: <span id="statusSpeed">1.0</span>x | 字體: <span id="statusFont">5</span> | 鏡像: <span id="statusMirror">正常</span></div>
    </div>
    
    <!-- 房間ID顯示 -->
    <div class="room-id-display">
        🏠 房間: <span id="currentRoomId">未連接</span>
    </div>
    
    <!-- 連接狀態 -->
    <div class="connection-status">
        <div id="connectionStatus">🔴 離線</div>
        <div>設備: <span id="deviceCount">0</span></div>
    </div>
    
    <!-- 設定按鈕 -->
    <button class="settings-toggle" onclick="toggleSettings()">⚙️ 設定</button>
    
    <!-- 設定面板 -->
    <div class="settings-panel" id="settingsPanel">
        <h2 style="margin-bottom: 20px; color: #fff;">提詞機設定</h2>
        
        <!-- 播放控制 -->
        <div class="setting-group">
            <label class="setting-label">播放控制</label>
            <div class="button-group">
                <button class="btn btn-success" onclick="playScript()">▶ 播放</button>
                <button class="btn btn-warning" onclick="pauseScript()">⏸ 暫停</button>
                <button class="btn btn-danger" onclick="stopScript()">⏹ 停止</button>
            </div>
        </div>
        
        <!-- 滾動設定 -->
        <div class="setting-group">
            <label class="setting-label">⚡ 滾動設定</label>
            <div class="slider-group">
                <div class="slider-label">
                    <span>滾動速度</span>
                    <span class="slider-value" id="speedValue">1.0</span>
                </div>
                <input type="range" min="0.1" max="5" step="0.1" value="1" class="setting-input" 
                       id="speedSlider" oninput="changeSpeed(this.value)">
            </div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>字體大小</span>
                    <span class="slider-value" id="fontSizeValue">5</span>
                </div>
                <input type="range" min="1" max="10" step="1" value="5" class="setting-input" 
                       id="fontSizeSlider" oninput="changeFontSize(this.value)">
            </div>
        </div>
        
        <!-- 文字顏色 -->
        <div class="setting-group">
            <label class="setting-label">文字顏色</label>
            <div class="color-picker" id="textColorPicker"></div>
        </div>
        
        <!-- 背景顏色 -->
        <div class="setting-group">
            <label class="setting-label">背景顏色</label>
            <div class="color-picker" id="bgColorPicker"></div>
        </div>
        
        <!-- 鏡像模式 -->
        <div class="setting-group">
            <label class="setting-label">鏡像模式</label>
            <div class="button-group">
                <button class="btn btn-primary" id="mirrorBtn-none" onclick="setMirror('none')">正常</button>
                <button class="btn btn-primary" id="mirrorBtn-horizontal" onclick="setMirror('horizontal')">水平</button>
            </div>
            <div class="button-group" style="margin-top: 5px;">
                <button class="btn btn-primary" id="mirrorBtn-vertical" onclick="setMirror('vertical')">垂直</button>
                <button class="btn btn-primary" id="mirrorBtn-both" onclick="setMirror('both')">雙向</button>
            </div>
        </div>
        
        <!-- 手動播放 -->
        <div class="setting-group">
            <label class="setting-label">🎯 手動播放</label>
            <div style="margin-bottom: 10px; font-size: 12px; color: #ccc;">
                模式: <span id="playbackModeDisplay">自動模式</span> | 
                目前第 <span id="currentLineDisplay">0</span> 行，共 <span id="totalLinesDisplay">0</span> 行
            </div>
            
            <!-- 行控制 -->
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <button class="btn btn-primary" onclick="previousLine()">⬆ 上一行</button>
                <button class="btn btn-primary" onclick="nextLine()">⬇ 下一行</button>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <input type="number" id="jumpToLineInput" min="1" value="1" class="setting-input" 
                       style="width: 80px;" placeholder="行號">
                <button class="btn btn-warning" onclick="jumpToLineFromInput()">跳轉到行</button>
            </div>
            
            <!-- 手動播放控制 -->
            <div class="button-group" style="margin-top: 10px;">
                <button class="btn btn-success" onclick="continueFromCurrentLine()" id="continueBtn" disabled>▶ 繼續提詞</button>
                <button class="btn btn-warning" onclick="pauseManualMode()" id="pauseManualBtn" disabled>⏸ 暫停</button>
                <button class="btn btn-danger" onclick="returnToAutoMode()" id="returnAutoBtn" disabled>🔄 回自動模式</button>
            </div>
        </div>
        
        <!-- 文稿管理 -->
        <div class="setting-group">
            <label class="setting-label">文稿內容</label>
            <textarea id="scriptEditor" rows="8" class="setting-input" 
                      placeholder="在此輸入文稿內容..." maxlength="2000"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="applyScript()">投影到主畫面</button>
            </div>
        </div>
        
        <!-- 文稿歷史 -->
        <div class="setting-group">
            <label class="setting-label">📚 文稿歷史</label>
            <div id="scriptHistory" class="script-history"></div>
            <div class="button-group">
                <button class="btn btn-success" onclick="saveCurrentScript()">💾 保存當前文稿</button>
                <button class="btn btn-danger" onclick="clearScriptHistory()">🗑️ 清空歷史</button>
            </div>
        </div>
        
        <!-- 關閉按鈕 -->
        <button class="btn btn-danger" onclick="toggleSettings()" style="width: 100%; margin-top: 20px;">
            關閉設定
        </button>
    </div>
    
    <!-- 主顯示容器 -->
    <div class="teleprompter-container">
        <!-- 行號顯示 -->
        <div class="line-numbers" id="lineNumbers"></div>
        
        <div class="teleprompter-content font-size-5" id="content">歡迎使用智慧提詞機<br>請開啟控制面板設定文稿內容<br><br>快捷鍵：<br>• 空白鍵：播放/暫停<br>• ESC：顯示設定<br>• ↑↓：調整速度<br>• ←→：調整字體</div>
    </div>
    
    <!-- 快捷鍵說明 -->
    <div class="help-overlay" id="helpOverlay">
        <h3>⌨️ 快捷鍵說明</h3>
        <div style="margin: 20px 0; text-align: left;">
            <div>空白鍵：播放/暫停</div>
            <div>ESC：顯示/隱藏此說明</div>
            <div>↑↓：調整滾動速度</div>
            <div>←→：調整字體大小</div>
            <div>S：停止滾動</div>
            <div>F：全螢幕模式</div>
        </div>
        <div style="margin-top: 20px;">
            <button onclick="hideHelp()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                關閉
            </button>
        </div>
    </div>

    <script>
        // 全域變數
        let peer = null;
        let connections = new Map();
        let isHost = false;
        let roomId = '';
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectDelay = 1000;
        
        // 提詞機設定
        let isPlaying = false;
        let scrollSpeed = 1.0;
        let fontSize = 5;
        let textColor = '#ffffff';
        let backgroundColor = '#000000';
        let mirrorMode = 'none';
        let scrollAnimation = null;
        
        // 手動行控制
        let scriptLines = [];
        let currentLineIndex = 0;
        let lineMode = false;
        let manualMode = false; // 手動播放模式開關
        
        // DOM 元素（將在DOM載入後初始化）
        let content = null;
        
        // 初始化
        window.addEventListener('DOMContentLoaded', function() {
            // 初始化DOM元素
            content = document.getElementById('content');
            
            // 確保 content 元素正確初始化
            if (content) {
                // 強制移除任何可能的鏡像類別和重置所有transform
                content.classList.remove('mirror-horizontal', 'mirror-vertical', 'mirror-both');
                content.style.transform = '';
                // 確保預設位置：正常方向，從底部開始
                content.style.transform = 'translateY(100vh) scaleX(1) scaleY(1)';
                console.log('✅ Content 元素初始化完成，移除任何翻轉效果');
            } else {
                console.error('❌ 找不到 content 元素');
            }
            
            initializePeer();
            setupKeyboardShortcuts();
            loadSettings();
            
            // 初始化文稿內容
            setTimeout(() => {
                updateScriptLines();
                updateLineNumbers();
                initializeSettings();
            }, 100);
        });
        
        // 檢查瀏覽器兼容性
        function checkBrowserCompatibility() {
            const issues = [];
            
            // 檢查 WebRTC 支援
            if (!window.RTCPeerConnection && !window.webkitRTCPeerConnection && !window.mozRTCPeerConnection) {
                issues.push('WebRTC不支援');
            }
            
            // 檢查 WebSocket 支援
            if (!window.WebSocket) {
                issues.push('WebSocket不支援');
            }
            
            // 檢查 localStorage 支援
            if (!window.localStorage) {
                issues.push('localStorage不支援');
            }
            
            // 檢查基本 ES6 功能
            try {
                new Map();
                new Set();
            } catch (e) {
                issues.push('ES6功能不完整');
            }
            
            return issues;
        }
        
        // 初始化 PeerJS
        function initializePeer() {
            try {
                // 檢查瀏覽器兼容性
                const compatibilityIssues = checkBrowserCompatibility();
                if (compatibilityIssues.length > 0) {
                    console.warn('⚠️ 瀏覽器兼容性問題:', compatibilityIssues.join(', '));
                    showNotification(`⚠️ 瀏覽器兼容性問題: ${compatibilityIssues.join(', ')}，建議使用Chrome或Firefox最新版本`);
                }
                
                // 檢查 PeerJS 是否成功載入
                if (typeof Peer === 'undefined') {
                    console.error('❌ PeerJS 庫未成功載入，請檢查網路連接');
                    updateConnectionStatus();
                    showNotification('❌ 無法載入PeerJS庫，請重新整理頁面或檢查網路連接');
                    return;
                }
                
                // 使用隨機ID避免衝突
                const randomId = 'main-' + Math.random().toString(36).substr(2, 9);
                
                // PeerJS 配置 - 使用多個可靠的配置選項
                const peerConfig = {
                    // 使用隨機生成的ID
                    key: 'peerjs',
                    debug: 1, // 啟用調試模式
                    secure: window.location.protocol === 'https:',
                    config: {
                        'iceServers': [
                            // Google STUN 服务器（全球覆盖）
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' },
                            
                            // Twilio STUN 服务器（可靠性高）
                            { urls: 'stun:global.stun.twilio.com:3478' },
                            
                            // Mozilla STUN 服务器（Firefox 优化）
                            { urls: 'stun:stun.mozilla.org:3478' },
                            
                            // OpenRelay STUN 服务器（开源稳定）
                            { urls: 'stun:openrelay.metered.ca:80' },
                            
                            // CloudFlare STUN 服务器（低延迟）
                            { urls: 'stun:stun.cloudflare.com:3478' },
                            
                            // 备用 STUN 服务器（特殊网络环境）
                            { urls: 'stun:relay.webrtc.win:3478' },
                            { urls: 'stun:stun.nextcloud.com:443' }
                        ],
                        'iceCandidatePoolSize': 15,
                        'iceTransportPolicy': 'all',
                        'bundlePolicy': 'balanced',
                        'rtcpMuxPolicy': 'require',
                        'sdpSemantics': 'unified-plan'
                    }
                };
                
                console.log('正在初始化PeerJS，ID:', randomId);
                peer = new Peer(randomId, peerConfig);

                peer.on('open', function(id) {
                    console.log('✅ PeerJS連線成功，Peer ID:', id);
                    isConnected = true;
                    roomId = id; // 使用Peer ID作為房間ID
                    reconnectAttempts = 0; // 成功連接後重置重連計數器
                    updateConnectionStatus();
                    
                    // 更新房間ID顯示
                    const roomDisplay = document.getElementById('currentRoomId');
                    if (roomDisplay) {
                        roomDisplay.textContent = id;
                    }
                    
                    showNotification('✅ 主顯示器已上線，房間ID: ' + id);
                });

                peer.on('connection', function(conn) {
                    console.log('📱 收到新的連線:', conn.peer);
                    handleNewConnection(conn);
                });

                peer.on('error', function(err) {
                    console.error('❌ PeerJS錯誤:', err.type, err.message);
                    isConnected = false;
                    updateConnectionStatus();
                    
                    // 智能重連機制
                    if (reconnectAttempts < maxReconnectAttempts) {
                        const delay = reconnectDelay * Math.pow(2, reconnectAttempts); // 指數退避
                        reconnectAttempts++;
                        
                        switch(err.type) {
                            case 'network':
                                console.log(`🔄 網路錯誤，${delay}ms後重新連接... (嘗試 ${reconnectAttempts}/${maxReconnectAttempts})`);
                                showNotification(`🔄 網路連接中斷，正在重連... (${reconnectAttempts}/${maxReconnectAttempts})`);
                                setTimeout(() => {
                                    if (peer) peer.destroy();
                                    initializePeer();
                                }, delay);
                                break;
                            case 'server-error':
                                console.log(`🔄 服務器錯誤，${delay}ms後重新連接... (嘗試 ${reconnectAttempts}/${maxReconnectAttempts})`);
                                showNotification(`🔄 服務器連接失敗，正在重連... (${reconnectAttempts}/${maxReconnectAttempts})`);
                                setTimeout(() => {
                                    if (peer) peer.destroy();
                                    initializePeer();
                                }, delay);
                                break;
                            case 'unavailable-id':
                                console.log('🔄 ID已被使用，立即重新生成...');
                                showNotification('🔄 ID衝突，正在重新生成...');
                                setTimeout(() => {
                                    if (peer) peer.destroy();
                                    initializePeer();
                                }, 500);
                                break;
                            case 'peer-unavailable':
                                console.log('⚠️ 對方不在線或ID不存在');
                                showNotification('⚠️ 目標設備不在線或ID不存在');
                                break;
                            default:
                                console.log('⚠️ 其他錯誤:', err.type);
                                showNotification(`⚠️ 連接錯誤: ${err.type}`);
                        }
                    } else {
                        console.error('❌ 重連次數已達上限，停止嘗試');
                        showNotification('❌ 多次重連失敗，請重新整理頁面或檢查網路');
                        reconnectAttempts = 0; // 重置計數器
                    }
                });

                peer.on('disconnected', function() {
                    console.log('🔌 PeerJS連線中斷，嘗試重連...');
                    isConnected = false;
                    updateConnectionStatus();
                    
                    // 嘗試重新連接到PeerJS服務器
                    if (!peer.destroyed) {
                        peer.reconnect();
                    }
                });
            } catch (error) {
                console.error('PeerJS初始化失敗:', error);
                updateConnectionStatus();
            }
        }
        
        // 處理新連接
        // 重複的函數已移除，使用下面更完整的版本
        
        // 處理新連線
        function handleNewConnection(conn) {
            // 將連線加入connections Map
            connections.set(conn.peer, conn);
            updateDeviceCount();
            
            conn.on('open', function() {
                console.log('✅ 控制設備已連接:', conn.peer);
                showNotification(`📱 控制設備已連接: ${conn.peer}`);
                
                // 發送當前設定給新連接的設備
                sendCurrentSettings(conn);
            });
            
            conn.on('data', function(message) {
                handleMessage(message, conn);
            });
            
            conn.on('close', function() {
                connections.delete(conn.peer);
                updateDeviceCount();
                console.log('📱 控制設備已斷開:', conn.peer);
                showNotification(`📱 控制設備已斷開: ${conn.peer}`);
            });
        }
        
        // 更新設備數量顯示
        function updateDeviceCount() {
            const deviceCountElement = document.getElementById('deviceCount');
            if (deviceCountElement) {
                deviceCountElement.textContent = connections.size;
            }
        }
        
        // 發送當前設定給連接的設備
        function sendCurrentSettings(conn) {
            if (!conn || !conn.open) {
                console.warn('連接不可用，無法發送設定');
                return;
            }
            
            const currentSettings = {
                fontSize: fontSize,
                scrollSpeed: scrollSpeed,
                textColor: textColor,
                backgroundColor: backgroundColor,
                mirrorMode: mirrorMode,
                totalLines: scriptLines.length,
                currentLine: currentLineIndex + 1,
                isPlaying: isPlaying,
                script: content ? content.textContent : ''
            };
            
            try {
                conn.send({
                    type: 'settings-sync',
                    data: currentSettings
                });
                console.log('設定已同步到設備:', conn.peer);
            } catch (error) {
                console.error('發送設定失敗:', error);
            }
        }
        
        // 廣播消息給所有連接的設備
        function broadcastMessage(type, data) {
            const message = { type: type, data: data };
            connections.forEach((conn, peerId) => {
                if (conn && conn.open) {
                    conn.send(message);
                }
            });
        }
        
        // 處理訊息
        function handleMessage(message, conn) {
            console.log('收到訊息:', message);
            
            switch (message.type) {
                case 'play-pause':
                    if (message.data.isPlaying) {
                        playScript();
                    } else {
                        pauseScript();
                    }
                    break;
                case 'play':
                    playScript();
                    break;
                case 'pause':
                    pauseScript();
                    break;
                case 'stop':
                    stopScript();
                    break;
                case 'speed-change':
                    changeSpeed(message.data.speed);
                    break;
                case 'font-change':
                    changeFontSize(message.data.fontSize);
                    break;
                case 'color-change':
                    if (message.data.textColor) setTextColor(message.data.textColor);
                    if (message.data.backgroundColor) setBackgroundColor(message.data.backgroundColor);
                    break;
                case 'mirror-change':
                    setMirror(message.data.mirrorMode);
                    break;
                case 'script-update':
                    updateScript(message.data.script);
                    break;
                case 'jump-to-line':
                    jumpToLine(message.data.line);
                    break;
                case 'previous-line':
                    previousLine();
                    break;
                case 'next-line':
                    nextLine();
                    break;
                case 'request-settings':
                    sendCurrentSettings(conn);
                    break;
            }
        }
        
        // 廣播訊息給所有連接的設備（移除重複定義）
        
        // 發送訊息給特定連接
        function sendToConnection(conn, type, data) {
            try {
                conn.send({ type: type, data: data });
            } catch (error) {
                console.error('發送訊息失敗:', error);
            }
        }
        
        // 發送當前設定（移除重複定義，使用上面的版本）
        
        // 播放控制
        function playScript() {
            if (isPlaying || !content) {
                console.log('播放已在進行中或content未初始化');
                return;
            }
            
            isPlaying = true;
            updateConnectionStatus();
            console.log('開始播放，速度:', scrollSpeed);
            
            if (lineMode) {
                // 行模式下不自動滾動
                console.log('行模式下不自動滾動');
                return;
            }
            
            // 連續滾動模式 - 修復版本
            const scrollDistance = scrollSpeed * 0.5; // 根據速度調整移動距離
            const intervalTime = Math.max(16, 50 / scrollSpeed); // 60fps最大，根據速度調整間隔
            
            scrollAnimation = setInterval(() => {
                if (!content) {
                    console.error('滾動過程中content丟失');
                    pauseScript();
                    return;
                }
                
                const currentTransform = content.style.transform || 'translateY(100vh)';
                let currentY;
                
                // 正確解析當前Y位置
                if (currentTransform.includes('translateY')) {
                    const match = currentTransform.match(/translateY\(([^)]+)\)/);
                    if (match) {
                        const value = match[1];
                        if (value.includes('vh')) {
                            currentY = window.innerHeight; // 100vh = 視窗高度
                        } else {
                            currentY = parseFloat(value) || window.innerHeight;
                        }
                    } else {
                        currentY = window.innerHeight;
                    }
                } else {
                    currentY = window.innerHeight;
                }
                
                // 往上滾動（減少Y值讓內容往上移動）
                const newY = currentY - scrollDistance;
                
                // 合併滾動和鏡像transform
                let finalTransform = `translateY(${newY}px)`;
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    // 正常模式：明確設置為不翻轉
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
                
                // 如果內容完全滾動出視窗上方，停止滾動（增加更多緩衝空間確保內容完全顯示）
                if (newY < -content.offsetHeight - 500) {
                    stopScript();
                    showNotification('✅ 提詞完成');
                }
            }, intervalTime);
            
            // 通知所有連接的設備
            broadcastMessage('play-state', { isPlaying: true });
        }
        
        function pauseScript() {
            isPlaying = false;
            updateConnectionStatus();
            console.log('暫停播放');
            
            if (scrollAnimation) {
                clearInterval(scrollAnimation);
                scrollAnimation = null;
            }
            
            // 通知所有連接的設備
            broadcastMessage('play-state', { isPlaying: false });
        }
        
        function stopScript() {
            console.log('停止播放並重置位置');
            pauseScript();
            
            if (!content) {
                console.error('Content未初始化，無法停止');
                return;
            }
            
            // 重置到開始位置，但保持鏡像模式
            let finalTransform = 'translateY(100vh)';
            if (mirrorMode && mirrorMode !== 'none') {
                switch (mirrorMode) {
                    case 'horizontal':
                        finalTransform += ' scaleX(-1) scaleY(1)';
                        break;
                    case 'vertical':
                        finalTransform += ' scaleX(1) scaleY(-1)';
                        break;
                    case 'both':
                        finalTransform += ' scaleX(-1) scaleY(-1)';
                        break;
                }
            } else {
                // 正常模式：明確設置為不翻轉
                finalTransform += ' scaleX(1) scaleY(1)';
            }
            content.style.transform = finalTransform;
            
            currentLineIndex = 0;
            
            if (lineMode) {
                displayCurrentLine();
            }
            
            // 更新行號顯示
            updateLineNumbers();
            
            // 通知所有連接的設備
            broadcastMessage('stop-state', { reset: true });
        }
        
        // 設定控制
        function changeSpeed(value) {
            scrollSpeed = parseFloat(value);
            document.getElementById('statusSpeed').textContent = scrollSpeed.toFixed(1);
            
            // 更新設定面板中的顯示
            const speedValue = document.getElementById('speedValue');
            if (speedValue) {
                speedValue.textContent = scrollSpeed.toFixed(1);
            }
            
            // 如果正在播放，重新開始以應用新速度
            if (isPlaying) {
                pauseScript();
                playScript();
            }
            
            // 通知連接的設備
            broadcastMessage('speed-change', { speed: scrollSpeed });
        }
        
        function changeFontSize(value) {
            fontSize = parseInt(value);
            content.className = content.className.replace(/font-size-\d+/, `font-size-${fontSize}`);
            document.getElementById('statusFont').textContent = fontSize;
            
            // 更新設定面板中的顯示
            const fontSizeValue = document.getElementById('fontSizeValue');
            if (fontSizeValue) {
                fontSizeValue.textContent = fontSize;
            }
            
            // 重新計算行數並更新
            updateScriptLines();
            
            // 字體大小改變時需要重新計算行號顯示
            setTimeout(updateLineNumbers, 100);
            
            // 通知連接的設備
            broadcastMessage('font-size-change', { fontSize: fontSize });
        }
        
        function setTextColor(color) {
            textColor = color;
            content.style.color = color;
            updateColorSelection('textColorPicker', color);
            broadcastMessage('color-change', { textColor: color });
        }
        
        function setBackgroundColor(color) {
            backgroundColor = color;
            document.body.style.backgroundColor = color;
            updateColorSelection('bgColorPicker', color);
            broadcastMessage('color-change', { backgroundColor: color });
        }
        
        function setMirror(mode) {
            if (!content) {
                console.error('Content 元素未初始化，無法設置鏡像模式');
                return;
            }
            
            mirrorMode = mode || 'none';
            
            // 更新狀態顯示
            const mirrorNames = {
                'none': '正常',
                'horizontal': '水平鏡像',
                'vertical': '垂直鏡像',
                'both': '雙向鏡像'
            };
            const statusMirror = document.getElementById('statusMirror');
            if (statusMirror) {
                statusMirror.textContent = mirrorNames[mode] || '正常';
            }
            
            // 更新鏡像按鈕狀態
            updateMirrorButtons(mode);
            
            // 重新應用transform（包含當前的滾動位置）
            const currentTransform = content.style.transform || 'translateY(100vh)';
            let translateY = 'translateY(100vh)';
            
            // 提取當前的translateY值
            if (currentTransform.includes('translateY')) {
                const match = currentTransform.match(/translateY\([^)]+\)/);
                if (match) {
                    translateY = match[0];
                } else {
                    translateY = 'translateY(100vh)';
                }
            }
            
            // 構建新的transform - 確保正常模式下明確設置scale為1
            let finalTransform = translateY;
            if (mode && mode !== 'none') {
                switch (mode) {
                    case 'horizontal':
                        finalTransform += ' scaleX(-1) scaleY(1)';
                        break;
                    case 'vertical':
                        finalTransform += ' scaleX(1) scaleY(-1)';
                        break;
                    case 'both':
                        finalTransform += ' scaleX(-1) scaleY(-1)';
                        break;
                }
            } else {
                // 正常模式：明確設置為不翻轉
                finalTransform += ' scaleX(1) scaleY(1)';
            }
            
            content.style.transform = finalTransform;
            console.log(`鏡像模式已設置為: ${mode}, transform: ${finalTransform}`);
            
            // 通知連接的設備
            broadcastMessage('mirror-change', { mirrorMode: mode });
        }
        
        function updateScript(scriptText) {
            content.textContent = scriptText;
            updateScriptLines();
        }
        
        // 手動行控制
        function updateScriptLines() {
            if (!content) {
                console.log('content元素未初始化');
                return;
            }
            
            // 獲取文本內容（處理HTML和純文本）
            let scriptText = '';
            if (content.innerHTML.includes('<br>')) {
                // 如果包含<br>標籤，將其轉換為換行符
                scriptText = content.innerHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '');
            } else {
                // 否則直接使用textContent
                scriptText = content.textContent || content.innerText || '';
            }
            
            console.log('原始文稿內容:', scriptText);
            
            // 按行分割，保留所有行（包括空行以維持段落格式）
            scriptLines = scriptText.split(/\r?\n/);
            
            console.log('分割後的行數:', scriptLines.length);
            console.log('前10行內容:', scriptLines.slice(0, 10));
            console.log('總字數:', scriptText.length);
            
            // 更新行數顯示
            updateLineDisplays();
            
            // 更新行號顯示
            updateLineNumbers();
            
            // 通知所有連接的設備，發送前100行到控制面板
            const first100Lines = scriptLines.slice(0, 100).join('\n');
            broadcastMessage('script-content', { 
                script: first100Lines,
                totalLines: scriptLines.length,
                fullContent: scriptText // 發送完整內容用於備份
            });
            broadcastMessage('total-lines', { totalLines: scriptLines.length });
            
            console.log('文稿更新，總共', scriptLines.length, '行，同步前100行到控制面板');
        }
        
        // 更新行號顯示
        function updateLineNumbers() {
            const lineNumbersContainer = document.getElementById('lineNumbers');
            if (!lineNumbersContainer) {
                console.warn('找不到行號容器');
                return;
            }
            
            // 清空現有行號
            lineNumbersContainer.innerHTML = '';
            
            // 如果沒有文稿內容，不顯示行號
            if (!scriptLines || scriptLines.length === 0) {
                console.log('無文稿內容，隱藏行號');
                return;
            }
            
            const totalLines = scriptLines.length;
            const currentLine = currentLineIndex + 1;
            
            console.log('更新行號顯示 - 總行數:', totalLines, '當前行:', currentLine);
            
            // 只有在有實際內容時才顯示行號
            if (totalLines > 0) {
                // 顯示當前行前後各5行，總共最多11行
                const displayRange = 5;
                let startLine = Math.max(1, currentLine - displayRange);
                let endLine = Math.min(totalLines, currentLine + displayRange);
                
                // 確保至少顯示11行（如果總行數足夠）
                const minDisplayLines = Math.min(11, totalLines);
                if (endLine - startLine + 1 < minDisplayLines) {
                    if (startLine === 1) {
                        endLine = Math.min(totalLines, startLine + minDisplayLines - 1);
                    } else if (endLine === totalLines) {
                        startLine = Math.max(1, endLine - minDisplayLines + 1);
                    }
                }
                
                // 生成行號
                for (let i = startLine; i <= endLine; i++) {
                    const lineNumberDiv = document.createElement('div');
                    lineNumberDiv.className = 'line-number';
                    lineNumberDiv.textContent = i;
                    lineNumberDiv.style.opacity = (i === currentLine) ? '1' : '0.5';
                    lineNumberDiv.style.fontWeight = (i === currentLine) ? 'bold' : 'normal';
                    lineNumberDiv.style.color = (i === currentLine) ? '#fff' : 'rgba(255, 255, 255, 0.5)';
                    
                    lineNumbersContainer.appendChild(lineNumberDiv);
                }
                
                console.log(`行號更新: 顯示 ${startLine}-${endLine}，當前行 ${currentLine}，總行數 ${totalLines}`);
            }
        }
        
        function jumpToLine(lineNumber) {
            if (lineNumber < 1 || lineNumber > scriptLines.length) {
                console.log('行號超出範圍:', lineNumber);
                return;
            }
            
            currentLineIndex = lineNumber - 1;
            enterManualMode();
            displayCurrentLine();
            
            // 更新顯示
            updateLineDisplays();
            
            // 通知控制設備
            broadcastMessage('current-line-update', { 
                currentLine: currentLineIndex + 1,
                totalLines: scriptLines.length 
            });
        }
        
        // 從輸入框跳轉到指定行
        function jumpToLineFromInput() {
            const input = document.getElementById('jumpToLineInput');
            if (input && input.value) {
                const lineNumber = parseInt(input.value);
                jumpToLine(lineNumber);
            }
        }
        
        // 更新行數顯示
        function updateLineDisplays() {
            const currentLineDisplay = document.getElementById('currentLineDisplay');
            const totalLinesDisplay = document.getElementById('totalLinesDisplay');
            
            if (currentLineDisplay) {
                currentLineDisplay.textContent = currentLineIndex + 1;
            }
            if (totalLinesDisplay) {
                totalLinesDisplay.textContent = scriptLines.length;
            }
            
            // 同時更新行號顯示
            updateLineNumbers();
        }
        
        function previousLine() {
            if (currentLineIndex > 0) {
                currentLineIndex--;
                enterManualMode();
                displayCurrentLine();
                updateLineDisplays();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        function nextLine() {
            if (currentLineIndex < scriptLines.length - 1) {
                currentLineIndex++;
                enterManualMode();
                displayCurrentLine();
                updateLineDisplays();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        // 進入手動模式
        function enterManualMode() {
            if (!manualMode) {
                manualMode = true;
                lineMode = true;
                
                // 停止自動播放
                if (isPlaying) {
                    pauseScript();
                }
                
                // 更新UI狀態
                updatePlaybackModeDisplay();
                enableManualControls();
                
                console.log('進入手動播放模式');
                broadcastMessage('manual-mode', { enabled: true });
            }
        }
        
        // 從當前行繼續提詞
        function continueFromCurrentLine() {
            if (!manualMode || scriptLines.length === 0) return;
            
            console.log('從第', currentLineIndex + 1, '行繼續提詞');
            
            // 設置內容到當前行位置並開始滾動提詞
            displayCurrentLine();
            
            // 開始自動滾動（但保持在手動模式）
            isPlaying = true;
            updateConnectionStatus();
            
            const scrollDistance = scrollSpeed * 0.5;
            const intervalTime = Math.max(16, 50 / scrollSpeed);
            
            scrollAnimation = setInterval(() => {
                if (!content) {
                    console.error('滾動過程中content丟失');
                    pauseManualMode();
                    return;
                }
                
                const currentTransform = content.style.transform || 'translateY(20vh)';
                let currentY = 20 * window.innerHeight / 100; // 20vh轉換為px
                
                if (currentTransform.includes('translateY')) {
                    const match = currentTransform.match(/translateY\(([^)]+)\)/);
                    if (match) {
                        const value = match[1];
                        if (value.includes('vh')) {
                            currentY = parseFloat(value) * window.innerHeight / 100;
                        } else {
                            currentY = parseFloat(value) || 20 * window.innerHeight / 100;
                        }
                    }
                }
                
                const newY = currentY - scrollDistance;
                
                let finalTransform = `translateY(${newY}px)`;
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
                
                // 檢查是否滾動完畢
                if (newY < -content.offsetHeight - 500) {
                    pauseManualMode();
                    showNotification('✅ 手動提詞完成');
                }
            }, intervalTime);
            
            broadcastMessage('manual-continue', { fromLine: currentLineIndex + 1 });
        }
        
        // 暫停手動模式
        function pauseManualMode() {
            isPlaying = false;
            updateConnectionStatus();
            
            if (scrollAnimation) {
                clearInterval(scrollAnimation);
                scrollAnimation = null;
            }
            
            console.log('手動模式暫停');
            broadcastMessage('manual-pause', {});
        }
        
        // 回到自動模式
        function returnToAutoMode() {
            console.log('回到自動模式');
            
            // 停止手動播放
            pauseManualMode();
            
            // 重置狀態
            manualMode = false;
            lineMode = false;
            currentLineIndex = 0;
            
            // 重置內容顯示
            if (content) {
                const scriptContent = document.getElementById('scriptEditor').value;
                if (scriptContent.trim()) {
                    content.innerHTML = scriptContent.replace(/\n/g, '<br>');
                } else {
                    content.innerHTML = '歡迎使用智慧提詞機<br>請開啟控制面板設定文稿內容<br><br>快捷鍵：<br>• 空白鍵：播放/暫停<br>• ESC：顯示設定<br>• ↑↓：調整速度<br>• ←→：調整字體';
                }
                
                // 重置到開始位置
                let finalTransform = 'translateY(100vh)';
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
            }
            
            // 更新UI狀態
            updatePlaybackModeDisplay();
            disableManualControls();
            updateScriptLines();
            updateLineNumbers();
            updateLineDisplays();
            
            showNotification('🔄 已回到自動模式');
            broadcastMessage('auto-mode', { enabled: true });
        }
        
        // 更新播放模式顯示
        function updatePlaybackModeDisplay() {
            const modeDisplay = document.getElementById('playbackModeDisplay');
            if (modeDisplay) {
                modeDisplay.textContent = manualMode ? '手動模式' : '自動模式';
                modeDisplay.style.color = manualMode ? '#ff9800' : '#4CAF50';
            }
        }
        
        // 啟用手動控制按鈕
        function enableManualControls() {
            const continueBtn = document.getElementById('continueBtn');
            const pauseManualBtn = document.getElementById('pauseManualBtn');
            const returnAutoBtn = document.getElementById('returnAutoBtn');
            
            if (continueBtn) continueBtn.disabled = false;
            if (pauseManualBtn) pauseManualBtn.disabled = false;
            if (returnAutoBtn) returnAutoBtn.disabled = false;
        }
        
        // 停用手動控制按鈕
        function disableManualControls() {
            const continueBtn = document.getElementById('continueBtn');
            const pauseManualBtn = document.getElementById('pauseManualBtn');
            const returnAutoBtn = document.getElementById('returnAutoBtn');
            
            if (continueBtn) continueBtn.disabled = true;
            if (pauseManualBtn) pauseManualBtn.disabled = true;
            if (returnAutoBtn) returnAutoBtn.disabled = true;
        }
        
        // 更新鏡像按鈕狀態
        function updateMirrorButtons(mode) {
            // 移除所有按鈕的active狀態
            ['none', 'horizontal', 'vertical', 'both'].forEach(m => {
                const btn = document.getElementById(`mirrorBtn-${m}`);
                if (btn) {
                    btn.classList.remove('active');
                }
            });
            
            // 添加當前模式按鈕的active狀態
            const activeBtn = document.getElementById(`mirrorBtn-${mode}`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            console.log('鏡像按鈕狀態已更新:', mode);
        }
        
        // 文稿歷史功能
        function saveCurrentScript() {
            const scriptText = document.getElementById('scriptEditor').value;
            if (!scriptText.trim()) {
                showNotification('⚠️ 文稿內容為空，無法保存');
                return;
            }
            
            const history = getScriptHistory();
            const timestamp = new Date().toLocaleString();
            const preview = scriptText.substring(0, 50) + (scriptText.length > 50 ? '...' : '');
            
            const newScript = {
                id: Date.now(),
                content: scriptText,
                timestamp: timestamp,
                preview: preview
            };
            
            history.unshift(newScript);
            
            // 限制歷史記錄數量
            if (history.length > 10) {
                history.splice(10);
            }
            
            localStorage.setItem('teleprompter-main-script-history', JSON.stringify(history));
            loadScriptHistory();
            showNotification('✅ 文稿已保存到歷史記錄');
        }
        
        function getScriptHistory() {
            try {
                const history = localStorage.getItem('teleprompter-main-script-history');
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('載入文稿歷史失敗:', error);
                return [];
            }
        }
        
        function loadScriptHistory() {
            const historyContainer = document.getElementById('scriptHistory');
            if (!historyContainer) return;
            
            const history = getScriptHistory();
            
            if (history.length === 0) {
                historyContainer.innerHTML = '<p style="color: #ccc; font-size: 12px;">暫無文稿歷史</p>';
                return;
            }
            
            historyContainer.innerHTML = history.map(script => `
                <div class="script-item">
                    <div class="script-preview">${script.preview}</div>
                    <div class="script-timestamp">${script.timestamp}</div>
                    <div class="script-actions">
                        <button onclick="loadScript(${script.id})" class="btn-small">載入</button>
                        <button onclick="deleteScript(${script.id})" class="btn-small delete-btn">刪除</button>
                    </div>
                </div>
            `).join('');
        }
        
        function loadScript(scriptId) {
            const history = getScriptHistory();
            const script = history.find(s => s.id === scriptId);
            
            if (script) {
                document.getElementById('scriptEditor').value = script.content;
                showNotification('✅ 文稿已載入');
            }
        }
        
        function deleteScript(scriptId) {
            const history = getScriptHistory().filter(s => s.id !== scriptId);
            localStorage.setItem('teleprompter-main-script-history', JSON.stringify(history));
            loadScriptHistory();
            showNotification('🗑️ 文稿已刪除');
        }
        
        function clearScriptHistory() {
            if (confirm('確定要清空所有文稿歷史嗎？')) {
                localStorage.removeItem('teleprompter-main-script-history');
                loadScriptHistory();
                showNotification('🗑️ 文稿歷史已清空');
            }
        }
        
        function displayCurrentLine() {
            if (scriptLines.length === 0) return;
            
            // 顯示當前行及前後文
            const contextLines = 3;
            const startIndex = Math.max(0, currentLineIndex - contextLines);
            const endIndex = Math.min(scriptLines.length, currentLineIndex + contextLines + 1);
            
            let displayText = '';
            for (let i = startIndex; i < endIndex; i++) {
                const line = scriptLines[i];
                if (i === currentLineIndex) {
                    displayText += `<span class="current-line-highlight">${line}</span>\n`;
                } else {
                    const opacity = Math.abs(i - currentLineIndex) <= 1 ? 1 : 0.6;
                    displayText += `<span style="opacity: ${opacity};">${line}</span>\n`;
                }
            }
            
            content.innerHTML = displayText;
            
            // 重置滾動位置以確保當前行可見
            content.style.transform = 'translateY(20vh)';
        }
        
        // 鍵盤快捷鍵
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (isPlaying) {
                            pauseScript();
                        } else {
                            playScript();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        toggleHelp();
                        break;
                    case 'KeyS':
                        e.preventDefault();
                        stopScript();
                        break;
                    case 'KeyF':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        changeSpeed(Math.min(5.0, scrollSpeed + 0.1));
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        changeSpeed(Math.max(0.1, scrollSpeed - 0.1));
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        changeFontSize(Math.max(1, fontSize - 1));
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        changeFontSize(Math.min(10, fontSize + 1));
                        break;
                }
            });
        }
        
        // 更新房間ID顯示（不重新生成roomId）
        function updateRoomDisplay() {
            const roomDisplay = document.getElementById('currentRoomId');
            if (roomDisplay && roomId) {
                roomDisplay.textContent = roomId;
                console.log('房間ID已更新顯示:', roomId);
            }
        }
        
        // 設定面板控制
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            if (panel) {
                // 使用CSS類別來控制面板顯示
                const isOpen = panel.classList.contains('open');
                if (isOpen) {
                    panel.classList.remove('open');
                    console.log('設定面板已關閉');
                } else {
                    panel.classList.add('open');
                    console.log('設定面板已開啟');
                }
            } else {
                console.error('找不到設定面板元素');
            }
        }
        
        // 應用文稿到主畫面
        function applyScript() {
            const scriptContent = document.getElementById('scriptEditor').value;
            if (scriptContent.trim()) {
                console.log('應用文稿:', scriptContent.substring(0, 100) + '...');
                
                // 更新主顯示內容
                content.innerHTML = scriptContent.replace(/\n/g, '<br>');
                
                // 重新初始化行數統計
                updateScriptLines();
                updateLineNumbers();
                
                // 重置到開始位置，保持當前鏡像模式
                let finalTransform = 'translateY(100vh)';
                if (mirrorMode && mirrorMode !== 'none') {
                    switch (mirrorMode) {
                        case 'horizontal':
                            finalTransform += ' scaleX(-1) scaleY(1)';
                            break;
                        case 'vertical':
                            finalTransform += ' scaleX(1) scaleY(-1)';
                            break;
                        case 'both':
                            finalTransform += ' scaleX(-1) scaleY(-1)';
                            break;
                    }
                } else {
                    finalTransform += ' scaleX(1) scaleY(1)';
                }
                content.style.transform = finalTransform;
                currentLineIndex = 0;
                
                showNotification('✅ 文稿已應用到主畫面');
                
                // 通知所有連接的設備
                broadcastMessage('script-update', { script: scriptContent });
            } else {
                showNotification('❌ 請先輸入文稿內容');
            }
        }
        
        // 設定滾動速度
        function setScrollSpeed(speed) {
            scrollSpeed = parseFloat(speed);
            document.getElementById('statusSpeed').textContent = scrollSpeed.toFixed(1);
            
            // 更新滑塊顯示
            const speedSlider = document.getElementById('speedSlider');
            const speedValueDisplay = document.getElementById('speedValue');
            if (speedSlider) speedSlider.value = scrollSpeed;
            if (speedValueDisplay) speedValueDisplay.textContent = scrollSpeed.toFixed(1);
            
            // 通知連接的設備
            broadcastMessage('speed-change', { speed: scrollSpeed });
        }
        
        // 設定字體大小
        function setFontSize(size) {
            fontSize = parseInt(size);
            changeFontSize(fontSize);
            
            // 更新滑塊顯示
            const fontSlider = document.getElementById('fontSlider');
            const fontValueDisplay = document.getElementById('fontSizeValue');
            if (fontSlider) fontSlider.value = fontSize;
            if (fontValueDisplay) fontValueDisplay.textContent = fontSize;
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            
            if (isConnected) {
                statusElement.innerHTML = '🟢 在線';
            } else {
                statusElement.innerHTML = '🔴 離線';
            }
        }
        
        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = connections.size;
        }
        
        function toggleHelp() {
            const helpOverlay = document.getElementById('helpOverlay');
            helpOverlay.classList.toggle('show');
        }
        
        function hideHelp() {
            document.getElementById('helpOverlay').classList.remove('show');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function loadSettings() {
            try {
                // 從 localStorage 載入設定
                const savedSettings = localStorage.getItem('teleprompter-settings');
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    console.log('載入已保存的設定:', settings);
                    
                    if (settings.textColor) setTextColor(settings.textColor);
                    if (settings.backgroundColor) setBackgroundColor(settings.backgroundColor);
                    if (settings.fontSize) changeFontSize(settings.fontSize);
                    if (settings.scrollSpeed) changeSpeed(settings.scrollSpeed);
                    
                    // 鏡像模式特別處理，確保預設為 'none'
                    if (settings.mirrorMode && settings.mirrorMode !== 'none') {
                        setMirror(settings.mirrorMode);
                    } else {
                        setMirror('none');
                    }
                } else {
                    console.log('沒有已保存的設定，使用預設值');
                    // 確保使用預設值
                    setMirror('none');
                }
            } catch (error) {
                console.error('載入設定時發生錯誤:', error);
                // 使用預設值
                setMirror('none');
            }
        }
        
        function saveSettings() {
            const settings = {
                textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode
            };
            localStorage.setItem('teleprompter-settings', JSON.stringify(settings));
        }
        
        // 頁面關閉前保存設定
        window.addEventListener('beforeunload', saveSettings);
        
        // 移除重複的函數定義（已在前面定義）
        
        // 顏色預設
        const COMMON_COLORS = [
            '#FFFFFF', '#F5F5F5', '#EEEEEE', '#DDDDDD', '#BBBBBB', '#999999', '#666666', '#000000',
            '#FFFEF7', '#FFF8DC', '#FFFFE0', '#FFFF99', '#FFFF00', '#FFD700', '#FFA500', '#FF8C00',
            '#FFEEE6', '#FFCC99', '#FFB366', '#FF9933', '#FF7F00', '#FF6347', '#D2691E', '#8B4513',
            '#FFE4E1', '#FFB6C1', '#FF69B4', '#FF1493', '#DC143C', '#B22222', '#8B0000', '#4B0000',
            '#E6F3FF', '#87CEEB', '#00BFFF', '#1E90FF', '#0066CC', '#003399', '#191970', '#000080',
            '#E6FFE6', '#90EE90', '#00FF00', '#32CD32', '#20B2AA', '#228B22', '#006400', '#013220',
            '#F0E6FF', '#DDA0DD', '#BA55D3', '#9932CC', '#8A2BE2', '#663399', '#4B0082', '#2E004B'
        ];
        
        // 建立顏色選擇器（防止重複創建）
        function createColorPickers() {
            const textPicker = document.getElementById('textColorPicker');
            const bgPicker = document.getElementById('bgColorPicker');
            
            if (textPicker && bgPicker) {
                // 清空現有內容，防止重複添加
                textPicker.innerHTML = '';
                bgPicker.innerHTML = '';
                
                COMMON_COLORS.forEach(color => {
                    // 文字顏色選擇器
                    const textOption = document.createElement('div');
                    textOption.className = 'color-option';
                    textOption.style.backgroundColor = color;
                    textOption.onclick = () => {
                        setTextColor(color);
                        updateColorSelection('textColorPicker', color);
                    };
                    textOption.title = color;
                    textPicker.appendChild(textOption);
                    
                    // 背景顏色選擇器
                    const bgOption = document.createElement('div');
                    bgOption.className = 'color-option';
                    bgOption.style.backgroundColor = color;
                    bgOption.onclick = () => {
                        setBackgroundColor(color);
                        updateColorSelection('bgColorPicker', color);
                    };
                    bgOption.title = color;
                    bgPicker.appendChild(bgOption);
                });
            }
        }
        
        // 更新顏色選擇狀態
        function updateColorSelection(pickerId, selectedColor) {
            const picker = document.getElementById(pickerId);
            if (!picker) return;
            
            picker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.style.backgroundColor === selectedColor ||
                    option.title === selectedColor) {
                    option.classList.add('selected');
                }
            });
        }
        
        // 更新速度顯示
        function updateSpeedDisplay() {
            const speedValue = document.getElementById('speedValue');
            if (speedValue) {
                speedValue.textContent = scrollSpeed.toFixed(1);
            }
        }
        
        // 更新字體大小顯示
        function updateFontSizeDisplay() {
            const fontSizeValue = document.getElementById('fontSizeValue');
            if (fontSizeValue) {
                fontSizeValue.textContent = fontSize;
            }
        }
        
        // 修改changeSpeed函數以更新顯示
        const originalChangeSpeed = changeSpeed;
        changeSpeed = function(speed) {
            originalChangeSpeed(speed);
            updateSpeedDisplay();
        };
        
        // 修改changeFontSize函數以更新顯示
        const originalChangeFontSize = changeFontSize;
        changeFontSize = function(size) {
            originalChangeFontSize(size);
            updateFontSizeDisplay();
        };
        
        // 初始化設定面板
        function initializeSettings() {
            createColorPickers();
            updateSpeedDisplay();
            updateFontSizeDisplay();
            updateColorSelection('textColorPicker', textColor);
            updateColorSelection('bgColorPicker', backgroundColor);
            
            // 初始化播放模式顯示
            updatePlaybackModeDisplay();
            disableManualControls();
            
            // 初始化鏡像按鈕狀態
            updateMirrorButtons(mirrorMode);
            
            // 同步滑動條位置
            const speedSlider = document.getElementById('speedSlider');
            const fontSizeSlider = document.getElementById('fontSizeSlider');
            
            if (speedSlider) {
                speedSlider.value = scrollSpeed;
            }
            if (fontSizeSlider) {
                fontSizeSlider.value = fontSize;
            }
            
            // 載入文稿歷史
            loadScriptHistory();
            
            // 更新行數顯示
            updateLineDisplays();
        }
        
        // 初始化行數統計
        window.addEventListener('load', function() {
            // 確保所有元素都已載入
            setTimeout(() => {
                console.log('頁面載入完成，初始化系統');
                updateScriptLines();
                initializeSettings();
                
                // 確保鏡像模式為預設值
                if (mirrorMode !== 'none') {
                    setMirror('none');
                }
                
                // 顯示初始化完成通知
                showNotification('✅ 智慧提詞機已初始化完成');
            }, 500);
        });
        
        // 通知系統
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // 添加通知動畫樣式
        const notificationStyle = document.createElement('style');
        notificationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(notificationStyle);
    </script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</body>
</html>
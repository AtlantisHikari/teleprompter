<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æè©æ©Ÿ - ä¸»é¡¯ç¤ºå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            background: #000;
            color: #fff;
            position: relative;
        }
        
        /* æè©æ©Ÿå®¹å™¨ */
        .teleprompter-container {
            width: 100%;
            height: 100vh;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .teleprompter-content {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 1.6;
            padding: 2rem;
            transform: translateY(100vh);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        /* 10å€‹å­—é«”å¤§å°ç­‰ç´š */
        .font-size-1 { font-size: 3vh; }
        .font-size-2 { font-size: 4vh; }
        .font-size-3 { font-size: 5vh; }
        .font-size-4 { font-size: 6.5vh; }
        .font-size-5 { font-size: 8vh; }
        .font-size-6 { font-size: 10vh; }
        .font-size-7 { font-size: 13vh; }
        .font-size-8 { font-size: 16vh; }
        .font-size-9 { font-size: 20vh; }
        .font-size-10 { font-size: 25vh; }
        
        /* é¡åƒæ•ˆæœ */
        .mirror-horizontal { transform: scaleX(-1); }
        .mirror-vertical { transform: scaleY(-1); }
        .mirror-both { transform: scale(-1, -1); }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        .status-bar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .room-id-display {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            z-index: 1000;
        }
        
        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
        }
        
        /* å¿«æ·éµæç¤º */
        .help-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            display: none;
            z-index: 2000;
        }
        
        .help-overlay.show {
            display: block;
        }
        
        /* è¡Œé«˜äº®æ¨£å¼ */
        .current-line-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0.2em;
            border-radius: 0.3em;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .teleprompter-content {
                padding: 1rem;
            }
            
            .status-bar, .room-id-display, .connection-status {
                font-size: 10px;
                padding: 8px 12px;
            }
        }
        
        /* è¨­å®šæŒ‰éˆ• */
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #666;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1001;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .settings-toggle:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: #999;
        }
        
        /* è¨­å®šé¢æ¿ */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -420px;
            width: 420px;
            height: 100vh;
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(10px);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            border-left: 2px solid #444;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        /* è¨­å®šé¢æ¿å…§å®¹æ¨£å¼ */
        .setting-group {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(50, 50, 50, 0.8);
            border-radius: 8px;
            border: 1px solid #555;
        }
        
        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #fff;
        }
        
        .setting-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #666;
            border-radius: 4px;
            background: #222;
            color: white;
            font-size: 14px;
        }
        
        .slider-group {
            margin-bottom: 20px;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .slider-value {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            flex: 1;
        }
        
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        
        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        /* é¡è‰²é¸æ“‡å™¨ */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 4px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 100%;
            height: 24px;
            border: 2px solid #666;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .color-option:hover {
            transform: scale(1.05);
            border-color: #fff;
        }
        
        .color-option.selected {
            border-color: #2196F3;
            border-width: 3px;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        }
        
        .color-option.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- ç‹€æ…‹åˆ— -->
    <div class="status-bar">
        <div>ğŸ“º ä¸»é¡¯ç¤ºå™¨</div>
        <div>é€Ÿåº¦: <span id="statusSpeed">1.0</span>x | å­—é«”: <span id="statusFont">5</span> | é¡åƒ: <span id="statusMirror">æ­£å¸¸</span></div>
    </div>
    
    <!-- æˆ¿é–“IDé¡¯ç¤º -->
    <div class="room-id-display">
        ğŸ  æˆ¿é–“: <span id="currentRoomId">æœªé€£æ¥</span>
    </div>
    
    <!-- é€£æ¥ç‹€æ…‹ -->
    <div class="connection-status">
        <div id="connectionStatus">ğŸ”´ é›¢ç·š</div>
        <div>è¨­å‚™: <span id="deviceCount">0</span></div>
    </div>
    
    <!-- è¨­å®šæŒ‰éˆ• -->
    <button class="settings-toggle" onclick="toggleSettings()">âš™ï¸ è¨­å®š</button>
    
    <!-- è¨­å®šé¢æ¿ -->
    <div class="settings-panel" id="settingsPanel">
        <h2 style="margin-bottom: 20px; color: #fff;">æè©æ©Ÿè¨­å®š</h2>
        
        <!-- æ’­æ”¾æ§åˆ¶ -->
        <div class="setting-group">
            <label class="setting-label">æ’­æ”¾æ§åˆ¶</label>
            <div class="button-group">
                <button class="btn btn-success" onclick="playScript()">â–¶ æ’­æ”¾</button>
                <button class="btn btn-warning" onclick="pauseScript()">â¸ æš«åœ</button>
                <button class="btn btn-danger" onclick="stopScript()">â¹ åœæ­¢</button>
            </div>
        </div>
        
        <!-- æ»¾å‹•è¨­å®š -->
        <div class="setting-group">
            <label class="setting-label">âš¡ æ»¾å‹•è¨­å®š</label>
            <div class="slider-group">
                <div class="slider-label">
                    <span>æ»¾å‹•é€Ÿåº¦</span>
                    <span class="slider-value" id="speedValue">1.0</span>
                </div>
                <input type="range" min="0.1" max="5" step="0.1" value="1" class="setting-input" 
                       id="speedSlider" oninput="changeSpeed(this.value)">
            </div>
            <div class="slider-group">
                <div class="slider-label">
                    <span>å­—é«”å¤§å°</span>
                    <span class="slider-value" id="fontSizeValue">5</span>
                </div>
                <input type="range" min="1" max="10" step="1" value="5" class="setting-input" 
                       id="fontSizeSlider" oninput="changeFontSize(this.value)">
            </div>
        </div>
        
        <!-- æ–‡å­—é¡è‰² -->
        <div class="setting-group">
            <label class="setting-label">æ–‡å­—é¡è‰²</label>
            <div class="color-picker" id="textColorPicker"></div>
        </div>
        
        <!-- èƒŒæ™¯é¡è‰² -->
        <div class="setting-group">
            <label class="setting-label">èƒŒæ™¯é¡è‰²</label>
            <div class="color-picker" id="bgColorPicker"></div>
        </div>
        
        <!-- é¡åƒæ¨¡å¼ -->
        <div class="setting-group">
            <label class="setting-label">é¡åƒæ¨¡å¼</label>
            <div class="button-group">
                <button class="btn btn-primary" onclick="setMirror('none')">æ­£å¸¸</button>
                <button class="btn btn-primary" onclick="setMirror('horizontal')">æ°´å¹³</button>
            </div>
            <div class="button-group" style="margin-top: 5px;">
                <button class="btn btn-primary" onclick="setMirror('vertical')">å‚ç›´</button>
                <button class="btn btn-primary" onclick="setMirror('both')">é›™å‘</button>
            </div>
        </div>
        
        <!-- æ–‡ç¨¿ç®¡ç† -->
        <div class="setting-group">
            <label class="setting-label">æ–‡ç¨¿å…§å®¹</label>
            <textarea id="scriptEditor" rows="8" class="setting-input" 
                      placeholder="åœ¨æ­¤è¼¸å…¥æ–‡ç¨¿å…§å®¹..."></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="applyScript()">æŠ•å½±åˆ°ä¸»ç•«é¢</button>
            </div>
        </div>
        
        <!-- é—œé–‰æŒ‰éˆ• -->
        <button class="btn btn-danger" onclick="toggleSettings()" style="width: 100%; margin-top: 20px;">
            é—œé–‰è¨­å®š
        </button>
    </div>
    
    <!-- ä¸»é¡¯ç¤ºå®¹å™¨ -->
    <div class="teleprompter-container">
        <div class="teleprompter-content font-size-5" id="content">
            æ­¡è¿ä½¿ç”¨æ™ºæ…§æè©æ©Ÿ<br>
            è«‹é–‹å•Ÿæ§åˆ¶é¢æ¿è¨­å®šæ–‡ç¨¿å…§å®¹<br><br>
            
            å¿«æ·éµï¼š<br>
            â€¢ ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ<br>
            â€¢ ESCï¼šé¡¯ç¤ºè¨­å®š<br>
            â€¢ â†‘â†“ï¼šèª¿æ•´é€Ÿåº¦<br>
            â€¢ â†â†’ï¼šèª¿æ•´å­—é«”<br>
        </div>
    </div>
    
    <!-- å¿«æ·éµèªªæ˜ -->
    <div class="help-overlay" id="helpOverlay">
        <h3>âŒ¨ï¸ å¿«æ·éµèªªæ˜</h3>
        <div style="margin: 20px 0; text-align: left;">
            <div>ç©ºç™½éµï¼šæ’­æ”¾/æš«åœ</div>
            <div>ESCï¼šé¡¯ç¤º/éš±è—æ­¤èªªæ˜</div>
            <div>â†‘â†“ï¼šèª¿æ•´æ»¾å‹•é€Ÿåº¦</div>
            <div>â†â†’ï¼šèª¿æ•´å­—é«”å¤§å°</div>
            <div>Sï¼šåœæ­¢æ»¾å‹•</div>
            <div>Fï¼šå…¨è¢å¹•æ¨¡å¼</div>
        </div>
        <div style="margin-top: 20px;">
            <button onclick="hideHelp()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                é—œé–‰
            </button>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let peer = null;
        let connections = new Map();
        let isHost = false;
        let roomId = '';
        let isConnected = false;
        
        // æè©æ©Ÿè¨­å®š
        let isPlaying = false;
        let scrollSpeed = 1.0;
        let fontSize = 5;
        let textColor = '#ffffff';
        let backgroundColor = '#000000';
        let mirrorMode = 'none';
        let scrollAnimation = null;
        
        // æ‰‹å‹•è¡Œæ§åˆ¶
        let scriptLines = [];
        let currentLineIndex = 0;
        let lineMode = false;
        
        // DOM å…ƒç´ 
        const content = document.getElementById('content');
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initializePeer();
            setupKeyboardShortcuts();
            loadSettings();
            generateRoomId();
        });
        
        // åˆå§‹åŒ– PeerJS
        function initializePeer() {
            try {
                // æª¢æŸ¥ PeerJS æ˜¯å¦æˆåŠŸè¼‰å…¥
                if (typeof Peer === 'undefined') {
                    console.error('âŒ PeerJS åº«æœªæˆåŠŸè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£æ¥');
                    updateConnectionStatus();
                    showNotification('âŒ ç„¡æ³•è¼‰å…¥PeerJSåº«ï¼Œè«‹é‡æ–°æ•´ç†é é¢æˆ–æª¢æŸ¥ç¶²è·¯é€£æ¥');
                    return;
                }
                
                // ä½¿ç”¨éš¨æ©ŸIDé¿å…è¡çª
                const randomId = 'main-' + Math.random().toString(36).substr(2, 9);
                
                // PeerJS é…ç½® - ä½¿ç”¨å¤šå€‹å¯é çš„é…ç½®é¸é …
                const peerConfig = {
                    // ä½¿ç”¨éš¨æ©Ÿç”Ÿæˆçš„ID
                    key: 'peerjs',
                    debug: 1, // å•Ÿç”¨èª¿è©¦æ¨¡å¼
                    secure: window.location.protocol === 'https:',
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ],
                        'iceCandidatePoolSize': 10
                    }
                };
                
                console.log('æ­£åœ¨åˆå§‹åŒ–PeerJSï¼ŒID:', randomId);
                peer = new Peer(randomId, peerConfig);

                peer.on('open', function(id) {
                    console.log('âœ… PeerJSé€£ç·šæˆåŠŸï¼ŒPeer ID:', id);
                    isConnected = true;
                    currentRoomId = id; // ä½¿ç”¨Peer IDä½œç‚ºæˆ¿é–“ID
                    updateConnectionStatus();
                    
                    // æ›´æ–°æˆ¿é–“IDé¡¯ç¤º
                    const roomDisplay = document.getElementById('currentRoomId');
                    if (roomDisplay) {
                        roomDisplay.textContent = id;
                    }
                });

                peer.on('connection', function(conn) {
                    console.log('ğŸ“± æ”¶åˆ°æ–°çš„é€£ç·š:', conn.peer);
                    handleNewConnection(conn);
                });

                peer.on('error', function(err) {
                    console.error('âŒ PeerJSéŒ¯èª¤:', err.type, err.message);
                    isConnected = false;
                    updateConnectionStatus();
                    
                    // æ›´è©³ç´°çš„éŒ¯èª¤è™•ç†
                    switch(err.type) {
                        case 'network':
                            console.log('ğŸ”„ ç¶²è·¯éŒ¯èª¤ï¼Œ3ç§’å¾Œé‡æ–°é€£æ¥...');
                            setTimeout(initializePeer, 3000);
                            break;
                        case 'server-error':
                            console.log('ğŸ”„ æœå‹™å™¨éŒ¯èª¤ï¼Œ5ç§’å¾Œé‡æ–°é€£æ¥...');
                            setTimeout(initializePeer, 5000);
                            break;
                        case 'unavailable-id':
                            console.log('ğŸ”„ IDå·²è¢«ä½¿ç”¨ï¼Œé‡æ–°ç”Ÿæˆ...');
                            setTimeout(initializePeer, 1000);
                            break;
                        case 'peer-unavailable':
                            console.log('âš ï¸ å°æ–¹ä¸åœ¨ç·šæˆ–IDä¸å­˜åœ¨');
                            break;
                        default:
                            console.log('âš ï¸ å…¶ä»–éŒ¯èª¤:', err.type);
                    }
                });

                peer.on('disconnected', function() {
                    console.log('ğŸ”Œ PeerJSé€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...');
                    isConnected = false;
                    updateConnectionStatus();
                    
                    // å˜—è©¦é‡æ–°é€£æ¥åˆ°PeerJSæœå‹™å™¨
                    if (!peer.destroyed) {
                        peer.reconnect();
                    }
                });
            } catch (error) {
                console.error('PeerJSåˆå§‹åŒ–å¤±æ•—:', error);
                updateConnectionStatus();
            }
        }
        
        // è™•ç†æ–°é€£æ¥
        function handleNewConnection(conn) {
            conn.on('open', function() {
                connections.set(conn.peer, conn);
                updateDeviceCount();
                console.log('æ–°è¨­å‚™å·²é€£æ¥:', conn.peer);
                
                // ç™¼é€ç•¶å‰è¨­å®šçµ¦æ–°é€£æ¥çš„è¨­å‚™
                sendToConnection(conn, 'settings-sync', {
                    textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode,
                    script: content.textContent,
                    totalLines: scriptLines.length,
                    currentLine: currentLineIndex + 1
                });
            });

            conn.on('data', function(message) {
                handleMessage(message, conn);
            });

            conn.on('close', function() {
                connections.delete(conn.peer);
                updateDeviceCount();
                console.log('è¨­å‚™å·²æ–·é–‹:', conn.peer);
            });
        }
        
        // è™•ç†è¨Šæ¯
        function handleMessage(message, conn) {
            console.log('æ”¶åˆ°è¨Šæ¯:', message);
            
            switch (message.type) {
                case 'play-pause':
                    if (message.data.isPlaying) {
                        playScript();
                    } else {
                        pauseScript();
                    }
                    break;
                case 'stop':
                    stopScript();
                    break;
                case 'speed-change':
                    changeSpeed(message.data.speed);
                    break;
                case 'font-change':
                    changeFontSize(message.data.fontSize);
                    break;
                case 'color-change':
                    if (message.data.textColor) setTextColor(message.data.textColor);
                    if (message.data.backgroundColor) setBackgroundColor(message.data.backgroundColor);
                    break;
                case 'mirror-change':
                    setMirror(message.data.mirrorMode);
                    break;
                case 'script-update':
                    updateScript(message.data.script);
                    break;
                case 'jump-to-line':
                    jumpToLine(message.data.line);
                    break;
                case 'previous-line':
                    previousLine();
                    break;
                case 'next-line':
                    nextLine();
                    break;
                case 'request-settings':
                    sendCurrentSettings(conn);
                    break;
            }
        }
        
        // å»£æ’­è¨Šæ¯çµ¦æ‰€æœ‰é€£æ¥
        function broadcastMessage(type, data) {
            connections.forEach(conn => {
                if (conn.open) {
                    sendToConnection(conn, type, data);
                }
            });
        }
        
        // ç™¼é€è¨Šæ¯çµ¦ç‰¹å®šé€£æ¥
        function sendToConnection(conn, type, data) {
            try {
                conn.send({ type: type, data: data });
            } catch (error) {
                console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', error);
            }
        }
        
        // ç™¼é€ç•¶å‰è¨­å®š
        function sendCurrentSettings(conn) {
            sendToConnection(conn, 'settings-response', {
                textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode,
                script: content.textContent,
                totalLines: scriptLines.length,
                currentLine: currentLineIndex + 1,
                isPlaying: isPlaying
            });
        }
        
        // æ’­æ”¾æ§åˆ¶
        function playScript() {
            if (isPlaying) return;
            
            isPlaying = true;
            updateConnectionStatus();
            
            if (lineMode) {
                // è¡Œæ¨¡å¼ä¸‹ä¸è‡ªå‹•æ»¾å‹•
                return;
            }
            
            // é€£çºŒæ»¾å‹•æ¨¡å¼
            const scrollDistance = 1; // æ¯æ¬¡ç§»å‹•çš„åƒç´ 
            const intervalTime = 50 / scrollSpeed; // æ ¹æ“šé€Ÿåº¦èª¿æ•´é–“éš”
            
            scrollAnimation = setInterval(() => {
                const currentTransform = content.style.transform || 'translateY(100vh)';
                const currentY = parseFloat(currentTransform.match(/translateY\\(([^)]+)\\)/)?.[1] || '100vh');
                const newY = currentY - scrollDistance;
                
                content.style.transform = `translateY(${newY}px)`;
                
                // å¦‚æœæ»¾å‹•å®Œç•¢ï¼Œåœæ­¢
                if (newY < -content.offsetHeight) {
                    stopScript();
                }
            }, intervalTime);
        }
        
        function pauseScript() {
            isPlaying = false;
            updateConnectionStatus();
            
            if (scrollAnimation) {
                clearInterval(scrollAnimation);
                scrollAnimation = null;
            }
        }
        
        function stopScript() {
            pauseScript();
            content.style.transform = 'translateY(100vh)';
            currentLineIndex = 0;
            
            if (lineMode) {
                displayCurrentLine();
            }
        }
        
        // è¨­å®šæ§åˆ¶
        function changeSpeed(value) {
            scrollSpeed = parseFloat(value);
            document.getElementById('statusSpeed').textContent = scrollSpeed.toFixed(1);
            
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œé‡æ–°é–‹å§‹ä»¥æ‡‰ç”¨æ–°é€Ÿåº¦
            if (isPlaying) {
                pauseScript();
                playScript();
            }
        }
        
        function changeFontSize(value) {
            fontSize = parseInt(value);
            content.className = content.className.replace(/font-size-\\d+/, `font-size-${fontSize}`);
            document.getElementById('statusFont').textContent = fontSize;
        }
        
        function setTextColor(color) {
            textColor = color;
            content.style.color = color;
        }
        
        function setBackgroundColor(color) {
            backgroundColor = color;
            document.body.style.backgroundColor = color;
        }
        
        function setMirror(mode) {
            mirrorMode = mode;
            content.className = content.className.replace(/mirror-\\w+/g, '');
            
            if (mode !== 'none') {
                content.classList.add(`mirror-${mode}`);
            }
            
            const mirrorNames = {
                'none': 'æ­£å¸¸',
                'horizontal': 'æ°´å¹³é¡åƒ',
                'vertical': 'å‚ç›´é¡åƒ',
                'both': 'é›™å‘é¡åƒ'
            };
            document.getElementById('statusMirror').textContent = mirrorNames[mode];
        }
        
        function updateScript(scriptText) {
            content.textContent = scriptText;
            updateScriptLines();
        }
        
        // æ‰‹å‹•è¡Œæ§åˆ¶
        function updateScriptLines() {
            const scriptText = content.textContent || '';
            scriptLines = scriptText.split('\\n').filter(line => line.trim() !== '');
            
            // é€šçŸ¥æ‰€æœ‰é€£æ¥çš„è¨­å‚™
            broadcastMessage('total-lines', { totalLines: scriptLines.length });
            
            console.log('æ–‡ç¨¿æ›´æ–°ï¼Œç¸½å…±', scriptLines.length, 'è¡Œ');
        }
        
        function jumpToLine(lineNumber) {
            if (lineNumber < 1 || lineNumber > scriptLines.length) {
                console.log('è¡Œè™Ÿè¶…å‡ºç¯„åœ:', lineNumber);
                return;
            }
            
            currentLineIndex = lineNumber - 1;
            lineMode = true;
            displayCurrentLine();
            
            // é€šçŸ¥æ§åˆ¶è¨­å‚™
            broadcastMessage('current-line-update', { 
                currentLine: currentLineIndex + 1,
                totalLines: scriptLines.length 
            });
        }
        
        function previousLine() {
            if (currentLineIndex > 0) {
                currentLineIndex--;
                lineMode = true;
                displayCurrentLine();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        function nextLine() {
            if (currentLineIndex < scriptLines.length - 1) {
                currentLineIndex++;
                lineMode = true;
                displayCurrentLine();
                
                broadcastMessage('current-line-update', { 
                    currentLine: currentLineIndex + 1,
                    totalLines: scriptLines.length 
                });
            }
        }
        
        function displayCurrentLine() {
            if (scriptLines.length === 0) return;
            
            // é¡¯ç¤ºç•¶å‰è¡ŒåŠå‰å¾Œæ–‡
            const contextLines = 3;
            const startIndex = Math.max(0, currentLineIndex - contextLines);
            const endIndex = Math.min(scriptLines.length, currentLineIndex + contextLines + 1);
            
            let displayText = '';
            for (let i = startIndex; i < endIndex; i++) {
                const line = scriptLines[i];
                if (i === currentLineIndex) {
                    displayText += `<span class="current-line-highlight">${line}</span>\\n`;
                } else {
                    const opacity = Math.abs(i - currentLineIndex) <= 1 ? 1 : 0.6;
                    displayText += `<span style="opacity: ${opacity};">${line}</span>\\n`;
                }
            }
            
            content.innerHTML = displayText;
            
            // é‡ç½®æ»¾å‹•ä½ç½®ä»¥ç¢ºä¿ç•¶å‰è¡Œå¯è¦‹
            content.style.transform = 'translateY(20vh)';
        }
        
        // éµç›¤å¿«æ·éµ
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                switch (e.code) {
                    case 'Space':
                        e.preventDefault();
                        if (isPlaying) {
                            pauseScript();
                        } else {
                            playScript();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        toggleHelp();
                        break;
                    case 'KeyS':
                        e.preventDefault();
                        stopScript();
                        break;
                    case 'KeyF':
                        e.preventDefault();
                        toggleFullscreen();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        changeSpeed(Math.min(5.0, scrollSpeed + 0.1));
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        changeSpeed(Math.max(0.1, scrollSpeed - 0.1));
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        changeFontSize(Math.max(1, fontSize - 1));
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        changeFontSize(Math.min(10, fontSize + 1));
                        break;
                }
            });
        }
        
        // å·¥å…·å‡½æ•¸
        function generateRoomId() {
            roomId = 'room-' + Math.random().toString(36).substr(2, 9);
            document.getElementById('currentRoomId').textContent = roomId;
            
            if (peer && peer.open) {
                isHost = true;
                console.log('æˆ¿é–“å·²å‰µå»º:', roomId);
            }
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            
            if (isConnected) {
                statusElement.innerHTML = 'ğŸŸ¢ åœ¨ç·š';
            } else {
                statusElement.innerHTML = 'ğŸ”´ é›¢ç·š';
            }
        }
        
        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = connections.size;
        }
        
        function toggleHelp() {
            const helpOverlay = document.getElementById('helpOverlay');
            helpOverlay.classList.toggle('show');
        }
        
        function hideHelp() {
            document.getElementById('helpOverlay').classList.remove('show');
        }
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        function loadSettings() {
            // å¾ localStorage è¼‰å…¥è¨­å®š
            const savedSettings = localStorage.getItem('teleprompter-settings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                if (settings.textColor) setTextColor(settings.textColor);
                if (settings.backgroundColor) setBackgroundColor(settings.backgroundColor);
                if (settings.fontSize) changeFontSize(settings.fontSize);
                if (settings.scrollSpeed) changeSpeed(settings.scrollSpeed);
                if (settings.mirrorMode) setMirror(settings.mirrorMode);
            }
        }
        
        function saveSettings() {
            const settings = {
                textColor, backgroundColor, fontSize, scrollSpeed, mirrorMode
            };
            localStorage.setItem('teleprompter-settings', JSON.stringify(settings));
        }
        
        // é é¢é—œé–‰å‰ä¿å­˜è¨­å®š
        window.addEventListener('beforeunload', saveSettings);
        
        // è¨­å®šé¢æ¿æ§åˆ¶
        function toggleSettings() {
            const settingsPanel = document.getElementById('settingsPanel');
            if (settingsPanel) {
                settingsPanel.classList.toggle('open');
            }
        }
        
        // æ‡‰ç”¨æ–‡ç¨¿åˆ°ä¸»ç•«é¢
        function applyScript() {
            const scriptText = document.getElementById('scriptEditor').value;
            if (scriptText.trim()) {
                content.textContent = scriptText;
                // å¦‚æœæœ‰é€£æ¥çš„æ§åˆ¶é¢æ¿ï¼Œä¹ŸåŒæ­¥æ›´æ–°
                connections.forEach(conn => {
                    sendToConnection(conn, 'script-update', { script: scriptText });
                });
            }
        }
        
        // é¡è‰²é è¨­
        const COMMON_COLORS = [
            '#FFFFFF', '#F5F5F5', '#EEEEEE', '#DDDDDD', '#BBBBBB', '#999999', '#666666', '#000000',
            '#FFFEF7', '#FFF8DC', '#FFFFE0', '#FFFF99', '#FFFF00', '#FFD700', '#FFA500', '#FF8C00',
            '#FFEEE6', '#FFCC99', '#FFB366', '#FF9933', '#FF7F00', '#FF6347', '#D2691E', '#8B4513',
            '#FFE4E1', '#FFB6C1', '#FF69B4', '#FF1493', '#DC143C', '#B22222', '#8B0000', '#4B0000',
            '#E6F3FF', '#87CEEB', '#00BFFF', '#1E90FF', '#0066CC', '#003399', '#191970', '#000080',
            '#E6FFE6', '#90EE90', '#00FF00', '#32CD32', '#20B2AA', '#228B22', '#006400', '#013220',
            '#F0E6FF', '#DDA0DD', '#BA55D3', '#9932CC', '#8A2BE2', '#663399', '#4B0082', '#2E004B'
        ];
        
        // å»ºç«‹é¡è‰²é¸æ“‡å™¨
        function createColorPickers() {
            const textPicker = document.getElementById('textColorPicker');
            const bgPicker = document.getElementById('bgColorPicker');
            
            if (textPicker && bgPicker) {
                COMMON_COLORS.forEach(color => {
                    // æ–‡å­—é¡è‰²é¸æ“‡å™¨
                    const textOption = document.createElement('div');
                    textOption.className = 'color-option';
                    textOption.style.backgroundColor = color;
                    textOption.onclick = () => {
                        setTextColor(color);
                        updateColorSelection('textColorPicker', color);
                    };
                    textOption.title = color;
                    textPicker.appendChild(textOption);
                    
                    // èƒŒæ™¯é¡è‰²é¸æ“‡å™¨
                    const bgOption = document.createElement('div');
                    bgOption.className = 'color-option';
                    bgOption.style.backgroundColor = color;
                    bgOption.onclick = () => {
                        setBackgroundColor(color);
                        updateColorSelection('bgColorPicker', color);
                    };
                    bgOption.title = color;
                    bgPicker.appendChild(bgOption);
                });
            }
        }
        
        // æ›´æ–°é¡è‰²é¸æ“‡ç‹€æ…‹
        function updateColorSelection(pickerId, selectedColor) {
            const picker = document.getElementById(pickerId);
            if (!picker) return;
            
            picker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.style.backgroundColor === selectedColor ||
                    option.title === selectedColor) {
                    option.classList.add('selected');
                }
            });
        }
        
        // æ›´æ–°é€Ÿåº¦é¡¯ç¤º
        function updateSpeedDisplay() {
            const speedValue = document.getElementById('speedValue');
            if (speedValue) {
                speedValue.textContent = scrollSpeed.toFixed(1);
            }
        }
        
        // æ›´æ–°å­—é«”å¤§å°é¡¯ç¤º
        function updateFontSizeDisplay() {
            const fontSizeValue = document.getElementById('fontSizeValue');
            if (fontSizeValue) {
                fontSizeValue.textContent = fontSize;
            }
        }
        
        // ä¿®æ”¹changeSpeedå‡½æ•¸ä»¥æ›´æ–°é¡¯ç¤º
        const originalChangeSpeed = changeSpeed;
        changeSpeed = function(speed) {
            originalChangeSpeed(speed);
            updateSpeedDisplay();
        };
        
        // ä¿®æ”¹changeFontSizeå‡½æ•¸ä»¥æ›´æ–°é¡¯ç¤º
        const originalChangeFontSize = changeFontSize;
        changeFontSize = function(size) {
            originalChangeFontSize(size);
            updateFontSizeDisplay();
        };
        
        // åˆå§‹åŒ–è¨­å®šé¢æ¿
        function initializeSettings() {
            createColorPickers();
            updateSpeedDisplay();
            updateFontSizeDisplay();
            updateColorSelection('textColorPicker', textColor);
            updateColorSelection('bgColorPicker', backgroundColor);
        }
        
        // åˆå§‹åŒ–è¡Œæ•¸çµ±è¨ˆ
        window.addEventListener('load', function() {
            setTimeout(updateScriptLines, 500);
            initializeSettings();
        });
        
        // é€šçŸ¥ç³»çµ±
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(76, 175, 80, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                z-index: 9999;
                font-size: 14px;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
        
        // æ·»åŠ é€šçŸ¥å‹•ç•«æ¨£å¼
        const notificationStyle = document.createElement('style');
        notificationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(notificationStyle);
    </script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</body>
</html>
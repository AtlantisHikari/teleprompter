<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ÊÖßÊèêË©ûÊ©ü - ‰∏ªÈ°ØÁ§∫Âô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }
        
        .main-content {
            position: relative;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .script-content {
            font-size: 5vh;
            line-height: 1.8;
            text-align: center;
            max-width: 90%;
            word-break: break-word;
            user-select: none;
            transition: all 0.3s ease;
        }
        
        .settings-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            bottom: 20px;
            width: 350px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 10px;
            padding: 20px;
            display: none;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow-y: auto;
            max-height: calc(100vh - 40px);
        }
        
        .settings-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            color: white;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }
        
        .room-id-display {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 20px;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        .control-input {
            width: 100%;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-family: inherit;
        }
        
        .control-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .control-btn {
            padding: 10px 15px;
            background: #4CAF50;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            margin: 5px 5px 5px 0;
            font-weight: bold;
        }
        
        .control-btn:hover {
            background: #45a049;
        }
        
        .control-btn.danger {
            background: #f44336;
        }
        
        .control-btn.danger:hover {
            background: #da190b;
        }
        
        .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .color-option {
            width: 100%;
            height: 25px;
            border: 2px solid #666;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.2s;
        }
        
        .color-option:hover {
            transform: scale(1.05);
            border-color: #fff;
        }
        
        .color-option.selected {
            border-color: #2196F3;
            border-width: 3px;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.6);
        }
        
        .color-option.selected::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .slider-container {
            margin: 10px 0;
        }
        
        .slider {
            width: 100%;
            margin: 5px 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        .connection-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            max-width: 300px;
        }
        
        @media (max-width: 768px) {
            .script-content {
                font-size: 4vh;
                padding: 20px;
            }
            
            .settings-panel {
                right: 10px;
                top: 10px;
                min-width: 280px;
            }
            
            .settings-toggle {
                right: 10px;
                top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="room-id-display" id="roomIdDisplay">
        ÊàøÈñìID: <span id="currentRoomId">Á≠âÂæÖÈÄ£Êé•...</span>
    </div>
    
    <button class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</button>
    
    <div class="settings-panel" id="settingsPanel">
        <div class="control-group">
            <label class="control-label">ÊàøÈñìË®≠ÂÆö</label>
            <input type="text" id="roomIdInput" class="control-input" placeholder="Ëº∏ÂÖ•ÊàøÈñìID">
            <button class="control-btn" onclick="createRoom()">ÂâµÂª∫ÊàøÈñì</button>
            <button class="control-btn" onclick="joinRoom()">Âä†ÂÖ•ÊàøÈñì</button>
        </div>
        
        <div class="control-group">
            <label class="control-label">Â≠óÈ´îÂ§ßÂ∞è: <span id="fontSizeValue">5</span></label>
            <input type="range" id="fontSizeSlider" class="slider" min="2" max="10" value="5">
        </div>
        
        <div class="control-group">
            <label class="control-label">ÊñáÂ≠óÈ°èËâ≤</label>
            <div class="color-grid" id="textColorPicker"></div>
        </div>
        
        <div class="control-group">
            <label class="control-label">ËÉåÊôØÈ°èËâ≤</label>
            <div class="color-grid" id="bgColorPicker"></div>
        </div>
        
        <div class="control-group">
            <label class="control-label">ÊñáÁ®øÂÖßÂÆπ</label>
            <textarea id="scriptInput" class="control-input" rows="5" placeholder="Ëº∏ÂÖ•ÊñáÁ®øÂÖßÂÆπ..."></textarea>
            <button class="control-btn" onclick="updateScript()">Êõ¥Êñ∞È°ØÁ§∫</button>
        </div>
        
        <div class="control-group">
            <button class="control-btn" onclick="openControlPanel()">üì± ÈñãÂïüÊéßÂà∂Èù¢Êùø</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="script-content" id="scriptContent">
            Ê≠°Ëøé‰ΩøÁî®Êô∫ÊÖßÊèêË©ûÊ©ü<br>
            Ë´ãÂú®Âè≥‰∏äËßíË®≠ÂÆö‰∏≠Ëº∏ÂÖ•ÊñáÁ®øÂÖßÂÆπ
        </div>
    </div>
    
    <div class="connection-info" id="connectionInfo">
        <div>üîó ÈÄ£Êé•ÁãÄÊÖã: <span id="connectionStatus">Èõ¢Á∑ö</span></div>
        <div>üì± Ë®≠ÂÇôÊï∏Èáè: <span id="deviceCount">0</span></div>
    </div>

    <script>
        // PeerJS Ë®≠ÂÆö (‰ΩøÁî®ÂÖçË≤ªÁöÑ PeerJS ÊúçÂãôÂô®)
        let peer = null;
        let connections = new Map();
        let isHost = false;
        let roomId = '';
        let currentSettings = {
            fontSize: 5,
            textColor: '#ffffff',
            backgroundColor: '#000000',
            script: 'Ê≠°Ëøé‰ΩøÁî®Êô∫ÊÖßÊèêË©ûÊ©ü\nË´ãÂú®Âè≥‰∏äËßíË®≠ÂÆö‰∏≠Ëº∏ÂÖ•ÊñáÁ®øÂÖßÂÆπ'
        };

        // Â∏∏Áî®È°èËâ≤
        const COMMON_COLORS = [
            '#ffffff', '#f0f0f0', '#d0d0d0', '#b0b0b0', '#808080', '#606060', '#404040', '#000000',
            '#fff8dc', '#ffffe0', '#ffff00', '#ffd700', '#ffa500', '#ff8c00', '#ff6347', '#ff4500',
            '#ffe4e1', '#ffc0cb', '#ff69b4', '#ff1493', '#dc143c', '#b22222', '#8b0000', '#800000',
            '#f0fff0', '#e6ffe6', '#98fb98', '#90ee90', '#00ff00', '#32cd32', '#228b22', '#008000',
            '#e0ffff', '#afeeee', '#87ceeb', '#87cefa', '#00bfff', '#1e90ff', '#0000ff', '#000080',
            '#f8f8ff', '#e6e6fa', '#dda0dd', '#da70d6', '#ba55d3', '#9370db', '#8a2be2', '#4b0082'
        ];

        // ÂàùÂßãÂåñ
        window.addEventListener('load', function() {
            initializePeer();
            setupUI();
        });

        // ÂàùÂßãÂåñ PeerJS
        function initializePeer() {
            try {
                // ‰ΩøÁî®ÂÆòÊñπ PeerJS Èõ≤Á´ØÊúçÂãô
                peer = new Peer({
                    secure: true,
                    config: {
                        'iceServers': [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:global.stun.twilio.com:3478' }
                        ]
                    }
                });

                peer.on('open', function(id) {
                    console.log('Peer ID:', id);
                    updateConnectionStatus('Â∑≤ÈÄ£Êé•Âà∞ÊúçÂãôÂô®');
                });

                peer.on('connection', function(conn) {
                    handleNewConnection(conn);
                });

                peer.on('error', function(err) {
                    console.error('PeerJSÈåØË™§:', err);
                    updateConnectionStatus('ÈÄ£Êé•ÈåØË™§: ' + err.type);
                    
                    // Â¶ÇÊûúÊòØÁ∂≤Ë∑ØÈåØË™§ÔºåÂòóË©¶ÈáçÊñ∞ÈÄ£Êé•
                    if (err.type === 'network' || err.type === 'server-error') {
                        setTimeout(() => {
                            console.log('ÂòóË©¶ÈáçÊñ∞ÈÄ£Êé•...');
                            initializePeer();
                        }, 3000);
                    }
                });
            } catch (error) {
                console.error('PeerJSÂàùÂßãÂåñÂ§±Êïó:', error);
                // Â¶ÇÊûú PeerJS ‰∏çÂèØÁî®Ôºå‰ΩøÁî®Êú¨Âú∞Ê®°Âºè
                updateConnectionStatus('Êú¨Âú∞Ê®°Âºè');
            }
        }

        // Ë®≠ÁΩÆUI
        function setupUI() {
            createColorPickers();
            setupEventListeners();
            applySettings();
        }

        // ÂâµÂª∫È°èËâ≤ÈÅ∏ÊìáÂô®
        function createColorPickers() {
            const textPicker = document.getElementById('textColorPicker');
            const bgPicker = document.getElementById('bgColorPicker');

            COMMON_COLORS.forEach(color => {
                // ÊñáÂ≠óÈ°èËâ≤
                const textOption = document.createElement('div');
                textOption.className = 'color-option';
                textOption.style.backgroundColor = color;
                textOption.onclick = () => setTextColor(color);
                textPicker.appendChild(textOption);

                // ËÉåÊôØÈ°èËâ≤
                const bgOption = document.createElement('div');
                bgOption.className = 'color-option';
                bgOption.style.backgroundColor = color;
                bgOption.onclick = () => setBackgroundColor(color);
                bgPicker.appendChild(bgOption);
            });

            updateColorSelection('textColorPicker', currentSettings.textColor);
            updateColorSelection('bgColorPicker', currentSettings.backgroundColor);
        }

        // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        function setupEventListeners() {
            const fontSizeSlider = document.getElementById('fontSizeSlider');
            fontSizeSlider.addEventListener('input', function() {
                setFontSize(this.value);
            });

            // ÈçµÁõ§Âø´Êç∑Èçµ
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    toggleSettings();
                }
            });
        }

        // ÊàøÈñìÁÆ°ÁêÜ
        function createRoom() {
            roomId = generateRoomId();
            document.getElementById('roomIdInput').value = roomId;
            document.getElementById('currentRoomId').textContent = roomId;
            isHost = true;
            updateConnectionStatus('ÊàøÈñìÂ∑≤ÂâµÂª∫');
        }

        function joinRoom() {
            const inputRoomId = document.getElementById('roomIdInput').value.trim();
            if (!inputRoomId) {
                alert('Ë´ãËº∏ÂÖ•ÊàøÈñìID');
                return;
            }

            if (peer && peer.open) {
                updateConnectionStatus('Ê≠£Âú®ÈÄ£Êé•ÊàøÈñì...');
                const conn = peer.connect(inputRoomId);
                
                conn.on('open', function() {
                    updateConnectionStatus('Â∑≤ÈÄ£Êé•Âà∞ÊàøÈñì');
                });
                
                conn.on('error', function(err) {
                    console.error('ÈÄ£Êé•ÊàøÈñìÂ§±Êïó:', err);
                    updateConnectionStatus('ÈÄ£Êé•ÊàøÈñìÂ§±Êïó');
                    alert('ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ÊàøÈñìÔºåË´ãÊ™¢Êü•ÊàøÈñìIDÊòØÂê¶Ê≠£Á¢∫');
                });
                
                handleNewConnection(conn);
                roomId = inputRoomId;
                document.getElementById('currentRoomId').textContent = roomId;
                isHost = false;
            } else {
                alert('Ë´ãÁ≠âÂæÖÈÄ£Êé•Âà∞ÊúçÂãôÂô®ÔºåÊàñÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢ÈáçË©¶');
            }
        }

        // ËôïÁêÜÊñ∞ÈÄ£Êé•
        function handleNewConnection(conn) {
            conn.on('open', function() {
                connections.set(conn.peer, conn);
                updateDeviceCount();
                updateConnectionStatus('Â∑≤ÈÄ£Êé•');

                // Â¶ÇÊûúÊòØ‰∏ªÊ©üÔºåÁôºÈÄÅÁï∂ÂâçË®≠ÂÆö
                if (isHost) {
                    conn.send({
                        type: 'settings',
                        data: currentSettings
                    });
                }
            });

            conn.on('data', function(message) {
                handleMessage(message, conn);
            });

            conn.on('close', function() {
                connections.delete(conn.peer);
                updateDeviceCount();
            });
        }

        // ËôïÁêÜÊ∂àÊÅØ
        function handleMessage(message, conn) {
            console.log('Êî∂Âà∞Ê∂àÊÅØ:', message);

            switch (message.type) {
                case 'settings':
                    currentSettings = { ...currentSettings, ...message.data };
                    applySettings();
                    break;
                case 'script':
                    currentSettings.script = message.data;
                    updateScriptDisplay();
                    break;
                case 'textColor':
                    setTextColor(message.data, false);
                    break;
                case 'backgroundColor':
                    setBackgroundColor(message.data, false);
                    break;
                case 'fontSize':
                    setFontSize(message.data, false);
                    break;
            }
        }

        // Âª£Êí≠Ê∂àÊÅØ
        function broadcastMessage(message) {
            connections.forEach(conn => {
                if (conn.open) {
                    conn.send(message);
                }
            });
        }

        // Ë®≠ÂÆöÂäüËÉΩ
        function setTextColor(color, broadcast = true) {
            currentSettings.textColor = color;
            document.getElementById('scriptContent').style.color = color;
            updateColorSelection('textColorPicker', color);

            if (broadcast) {
                broadcastMessage({
                    type: 'textColor',
                    data: color
                });
            }
        }

        function setBackgroundColor(color, broadcast = true) {
            currentSettings.backgroundColor = color;
            document.body.style.backgroundColor = color;
            updateColorSelection('bgColorPicker', color);

            if (broadcast) {
                broadcastMessage({
                    type: 'backgroundColor',
                    data: color
                });
            }
        }

        function setFontSize(size, broadcast = true) {
            currentSettings.fontSize = size;
            document.getElementById('scriptContent').style.fontSize = size + 'vh';
            document.getElementById('fontSizeValue').textContent = size;
            document.getElementById('fontSizeSlider').value = size;

            if (broadcast) {
                broadcastMessage({
                    type: 'fontSize',
                    data: size
                });
            }
        }

        function updateScript() {
            const script = document.getElementById('scriptInput').value;
            currentSettings.script = script;
            updateScriptDisplay();

            broadcastMessage({
                type: 'script',
                data: script
            });
        }

        function updateScriptDisplay() {
            const content = document.getElementById('scriptContent');
            content.innerHTML = currentSettings.script.replace(/\n/g, '<br>');
        }

        // È°èËâ≤ÈÅ∏ÊìáÊõ¥Êñ∞
        function updateColorSelection(pickerId, selectedColor) {
            const picker = document.getElementById(pickerId);
            picker.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
                if (option.style.backgroundColor === selectedColor ||
                    rgbToHex(option.style.backgroundColor) === selectedColor) {
                    option.classList.add('selected');
                }
            });
        }

        function rgbToHex(rgb) {
            if (rgb.startsWith('#')) return rgb;
            const result = rgb.match(/\d+/g);
            if (!result) return rgb;
            return "#" + ((1 << 24) + (parseInt(result[0]) << 16) + (parseInt(result[1]) << 8) + parseInt(result[2])).toString(16).slice(1);
        }

        // ÊáâÁî®ÊâÄÊúâË®≠ÂÆö
        function applySettings() {
            setTextColor(currentSettings.textColor, false);
            setBackgroundColor(currentSettings.backgroundColor, false);
            setFontSize(currentSettings.fontSize, false);
            updateScriptDisplay();
            document.getElementById('scriptInput').value = currentSettings.script;
        }

        // UI ÂäüËÉΩ
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function openControlPanel() {
            window.open(window.location.href, '_blank');
        }

        // Â∑•ÂÖ∑ÂáΩÊï∏
        function generateRoomId() {
            return 'room-' + Math.random().toString(36).substr(2, 9);
        }

        function updateConnectionStatus(status) {
            document.getElementById('connectionStatus').textContent = status;
        }

        function updateDeviceCount() {
            document.getElementById('deviceCount').textContent = connections.size;
        }
    </script>
    
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</body>
</html>